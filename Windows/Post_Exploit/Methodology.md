# Windows - Post-Exploit

Post exploitation should include:

  - Retrieving sensible information stored on the compromised hosts
  -

### Looting

###### RDP Session Hijacking

If Administrator / SYSTEM privileges could be obtained on a host, RDP sessions
of others users can be hijacked. This could be used to access the
host as the hijacked user through a GUI interface with out knowing its password.

Note that:
  - Hijacking of disconnected sessions is possible
  - Hijacking a session will unlock locked sessions (with out the need to
    provide credentials)

Retrieve the ID of the eventual RDP sessions present on the host:

```
# SESSIONNAME = rdp-*
query user
```

Create and start a service that will execute tscon to hijack the specified RDP
session:

```
sc create sesshijack binpath= "cmd.exe /k tscon <SESSION_ID> /dest:<SESSION_NAME>"
net start sesshijack
```

### Manage

###### Windows Firewall

To check whether the Windows Firewall is enabled on a server or computer,
the following command can be used as Administrator/SYSTEM:

```bash
netsh advfirewall show allprofiles
```

By default, three separate listings are present: Domain profile settings,
private profile settings and public profile settings.  
With the private profile, applied to a network adapter when it is connected
to a network that is identified by the user or administrator as a private
network, Windows enables network discovery features, allows file sharing and
other networked features.   
The public profile, applied to a network adapter by default or if specified so
by an user or administrator, is the most restrictive profile. In the default
public profile, Windows will block all inbound connections to programs that are
not on the list of allowed programs.   
Finally, the Domain profile is used when a server or computer is joined to an
Active Directory domain. In this environment, firewall settings are typically
(but not necessarily) controlled by a network administrator.

To disable the firewall use the following commands:

```
# Disable current profile
netsh advfirewall set currentprofile state off

# Disable all profiles
netsh advfirewall set allprofiles state off

# Disable the private, public and domain profiles
netsh advfirewall set privateprofile state off
netsh advfirewall set publicprofile state off
netsh advfirewall set domainprofile state off
```

To open a specific port, or a range, use the following command:

```
netsh advfirewall firewall add rule name="<RULE_NAME" protocol=TCP dir=in localport=<PORT> action=allow
```

### Persistence

###### Add local Administrator

The net user commands can be used to create and add a windows account in the
administrator group:

```
# Create a new account
net user /add <USERNAME> <PASSWORD>

# Add account as administrator
net localgroup Administrators <USERNAME> /add
net localgroup Administrateurs <USERNAME> /add
```

###### Sticky Keys or Utilman backdoors

Both the Sticky Keys (sethc.exe) and Utilman (utilman.exe) utility tools can be
launched at the login screen before authentication as NT AUTHORITY\SYSTEM.

Replacing either of those binaries with cmd.exe can be a way to maintain
persistence on the compromised system.

```
cd windows\system32
copy cmd.exe sethc.exe
copy cmd.exe utilman.exe
```

The sethc.exe is launched after pushing the Maj key five times and the
utilman.exe can be started using Win + u.

However, a graphical access to the host login prompt is needed in order to
make use of this backdoor mechanism.  
To do so remotely:

  - RDP must be enabled and not firewalled on the host
  - RDP NLA deactivated if no valid credentials are known. Valid credentials
  could be used to access the graphical login prompt even if the user used is
  not in the Remote Desktop Users group. For more information, refer to the
  [L7] RDP note.
