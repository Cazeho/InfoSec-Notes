# Active Directory - Operators to Domain Admins

### Overview

### Administrators

The built-in `Administrators` / `Administrateurs` `domain local` group (`SID:
S-1-5-32-544`) correspond to the original local `Administrators` group of
servers being promoted to being Domain Controllers. The domain `Administrators`
group, and its members, are protected by the `AdminSDHolder` mechanism.

The members of the domain `Administrators` group:

  - Have full control over all the Domain Controllers of the domain. Among
    others possibilities, this access can be leveraged to remotely connect to a
    Domain Controller and dump the Active Directory `ntds.dit` database. Refer
    to the `[ActiveDirectory] ntds.dit dumping` for note for techniques to do
    so.

  - Can by default take ownership (`WriteOwner`) and modify the `DACL`
    (`WriteDacl`) and properties (`WriteProperty` on `00000000-[...]00`) of
    most Active Directory objects. Including the privileged principals (`Domain
    Admins`, `Enterprise Admins`, etc.) protected by the `AdminSDHolder`
    mechanism. Those rights can be leveraged to add member(s) to the privileged
    domain groups or change the password of privileged users. Refer to the
    `[ActiveDirectory] ACL exploiting - Users and groups permissions
    exploitation` note more information on how to conduct this kind of attacks.

```
# Validates the presence of the default ACL relative to the domain Administrators group on the AdminSDHolder object.
# DOMAIN_ROOT_OBJECT = "DC=LAB,DC=AD" for example

Get-Acl "AD:\CN=AdminSDHolder,CN=System,<DOMAIN_ROOT_OBJECT>" | Select-Object -ExpandProperty Access | ? IdentityReference -match "Administrators"

  ActiveDirectoryRights : CreateChild, DeleteChild, Self, WriteProperty, ExtendedRight, Delete, GenericRead, WriteDacl,WriteOwner
  InheritanceType       : None
  ObjectType            : 00000000-0000-0000-0000-000000000000
  InheritedObjectType   : 00000000-0000-0000-0000-000000000000
  ObjectFlags           : None
  AccessControlType     : Allow
  IdentityReference     : BUILTIN\Administrators
  IsInherited           : False
  InheritanceFlags      : None
  PropagationFlags      : None
```

### Account Operators

The members of the `Account Operators` / `Op√©rateurs de compte` `domain local`
group (`SID: S-1-5-32-548`) have full control over user and machine accounts
and domain groups, except for the accounts and groups that are protected by
the `AdminSDHolder` mechanism. The domain `Account Operators` group, and its
members, are protected by the `AdminSDHolder` mechanism.

Membership to the domain `Account Operators` group can be leveraged to:

  - Add member(s) to the `DnsAdmins` group, which is not protected by the
    `AdminSDHolder` mechanism, to remotely execute code as
    `NT AUTHORITY\SYSTEM` on a Domain Controller.  

    ```
    # Validates the presence of the default ACL relative to the Account Operators group on the DnsAdmins group.
    # DOMAIN_ROOT_OBJECT = "DC=LAB,DC=AD" for example
    Get-Acl "AD:\CN=DnsAdmins,CN=Users,<DOMAIN_ROOT_OBJECT>" | Select-Object -ExpandProperty Access | ? IdentityReference -match "Account Operators"

      ActiveDirectoryRights : GenericAll
      InheritanceType       : None
      ObjectType            : 00000000-0000-0000-0000-000000000000
      InheritedObjectType   : 00000000-0000-0000-0000-000000000000
      ObjectFlags           : None
      AccessControlType     : Allow
      IdentityReference     : BUILTIN\Account Operators
      IsInherited           : False
      InheritanceFlags      : None
      PropagationFlags      : None

    net localgroup "DnsAdmins" "<DOMAIN>\<USERNAME>" /add /domain
    dsmod.exe group "CN=DnsAdmins,CN=Users,<DOMAIN_ROOT_OBJECT>" -addmbr "<USER_DISTINGUISHED_NAME"

    Add-ADGroupMember -Identity "DnsAdmins" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
    Add-ADGroupMember -Server <DC_HOSTNAME | DC_IP> -Domain <DOMAIN> -Credential <PSCredentials> -Identity "DnsAdmins" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
    ```

  - Take control of non-protected machines where privileged users have opened a
    session. `PowerView`'s cmdlets and `SharpHound` both wrap around the
    Windows `Win32API`'s `NetSessionEnum` API and can be used to enumerate
    sessions on remote systems. Refer to the `[ActiveDirectory] Credentials
    theft shuffling - Session hunting` and `[ActiveDirectory] AD scanners`
    notes for more information.

    Multiples techniques may be leveraged to take control of the non protected
    machines, including:

    - Reading the `Local Administrator Password Solution (LAPS)` password of
    the non-protected machines if the solution is deployed on the domain, as
    the `Account Operators` group can by default read all attributes of
    the machine accounts (including the `ms-Mcs-AdmPwd` attribute).

      ```
      Get-ADComputer -Identity <SamAccountName | DistinguishedName | SID | GUID> -Properties * | Ft Name,ms-Mcs-AdmPwdExpirationTime,ms-Mcs-AdmPwd
      Get-ADComputer -Filter {ms-mcs-admpwdexpirationtime -like "*"} -Properties * | Ft Name,ms-Mcs-AdmPwdExpirationTime,ms-Mcs-AdmPwd
      ```

    - Add member(s) to non-protected domain group, or change password of
    non-protected domain users, that are members of the local `Administrators`
    group of the targeted machine. `PowerView`'s cmdlets, `PingCastle`'s
    `localadmin` scanner and `SharpHound`'s `LocalAdmin` collection method can
    all be used to enumerate local groups memberships through `RPC` calls to
    the `SAMR` interface of the remote system (either through direct `RPC`
    calls or through the `NetLocalGroupGetMembers` Windows API). Refer to the
    `[ActiveDirectory] Credentials theft shuffling - Local group enumeration`
    for more information.

### Backup Operators

### DNS Admins

### Print Operators

### Schema Admins

### Server Operators
