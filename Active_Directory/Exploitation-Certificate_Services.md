# Active Directory - Certificate Services

### Overview

###### Extended / Enhanced Key Usage extension

The `Extended / Enhanced Key Usage (EKU)` extension is a certificate extension
(i.e an additional attribute) that defines the purposes of the certificate,
effectively restricting what the certificate can be used for in an Active
Directory environment. This extension is implemented by the
`pKIExtendedKeyUsage` attribute on Active Directory certificate template
object.

The `EKU` extension is composed of 0 or more `Object Identifier (OID)`, each
`OID` corresponding to a specific purpose. The following notable `OIDs` are
supported in Active Directory:

| OID | Name / Description | Usage |
|-----|--------|-------|
| `2.5.29.37.0` | `anyExtendedKeyUsage` | Certificate that can be used for any usage. |
| `1.3.6.1.5.5.7.3.2` | `clientAuth` | Certificate used for client authentication (be it  `SSL` / `TLS` authentication for web client or to remote servers in Active Directory). |
| `1.3.6.1.5.5.7.3.3` | `codeSigning` | Code signing certificate used to digitally sign executables (such as `PE` binaries or PowerShell scripts). |
| `1.3.6.1.5.5.7.3.4` | `emailProtection` | Certificate used to encrypt or digitally sign emails through the `S/MIME` standard. |
| `1.3.6.1.5.5.7.3.5` <br> `1.3.6.1.5.5.7.3.6` <br> `1.3.6.1.5.5.7.3.7` | `ipsecEndSystem` <br> `ipsecTunnel` <br> `ipsecUser` | Certificates used in an Internet Protocol SECurity (IPSEC) infrastructure. |
| `1.3.6.1.5.2.3.4` | `keyPurposeClientAuth` | Certificate used in Active Directory for PKINIT client authentication (not present by default and requires to be manually added in the certificate template). |
| `1.3.6.1.4.1.311.10.3.4` | `msEFS` | Certificate used to encrypt / decrypt `Encrypting File System (EFS)` `NTFS` filesystems on Windows. |  
| `1.3.6.1.5.5.7.3.1` | `serverAuth` | Certificate used for server authentication (for instance using the `SSL` / `TLS` protocol). |
| `1.3.6.1.4.1.311.20.2.2` | `Smartcard logon` | Certificate used for smart card logon. |

If no `OID` is specified in the `EKU` extension, the certificate will by
default be valid for all usages in Windows, including client authentication.
Applications may however rely on the `Constrained` `EKU` validation mode,
as implemented by Microsoft, which determine the valid usage of the certificate
using only the explicitly specified purposes (in all the certificate of the
chain).

### Certificates exploitation

###### Code signing certificate

`Code Signing` certificates (`OID 1.3.6.1.5.5.7.3.3`) can be used to sign `PE`
binaries or PowerShell scripts.

Digitally signed executables can be exempted from `User Account Control (UAC)`
or `Windows SmartScreen` prompt. Additionally, on systems with `AppLocker`
enabled, `Windows Installer` files digitally signed by a trusted publisher can
be installed by non-privileged users, resulting in a potential local privilege
escalation.

```
# Lists the certificates with code-signing authority stored in the specified certificate store.
Get-ChildItem -Path Cert:<\CurrentUser\My | CERTIFICATE_STORE> -CodeSigningCert

# Uses a code-signing certificate in the specified store.
$cert = Get-ChildItem -Path Cert:<\CurrentUser\My | CERTIFICATE_STORE> -CodeSigningCert

# Uses the specified PFX certificate file.
$cert = Get-PfxCertificate -FilePath <CERTIFICATE_PFX>

# Signs the given file using the code-signing certificate specified.
Set-AuthenticodeSignature -Certificate $cert [-HashAlgorithm <sha1 | sha256>] [-TimestampServer "<http://timestamp.digicert.com | TIMESTAMP_SERVER_URL>"] -FilePath <FILE_TO_SIGN>
```

--------------------------------------------------------------------------------

### References

https://ldapwiki.com/wiki/ExtendedKeyUsage
https://www.sysadmins.lv/blog-en/constraining-extended-key-usages-in-microsoft-windows.aspx
https://posts.specterops.io/certified-pre-owned-d95910965cd2
https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf
