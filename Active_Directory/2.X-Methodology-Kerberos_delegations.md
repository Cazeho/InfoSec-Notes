# Active Directory - Kerberos delegations

### Overview

`Kerberos` is an authentication protocol used within Active Directory that rely
on the use of tickets to identify users and grant access to domain resources.
To do so, `Kerberos` implements two type of tickets, issued by two distinct
services of the `Key Distribution Center (KDC)`:
  - `Ticket-Granting Ticket (TGT)`, obtained from the `Authentication Service
  (AS)`.
  - `service tickets`, obtained from the `Ticket-Granting Service (TGS)`.

A valid `TGT` is necessary in order to request `service tickets`, which in turn
grant access to service accounts (user or machine domain accounts that have a
`ServicePrincipalName (SPN)`).

###### Unconstrained, constrained and resource-based constrained delegations

Three types of delegation are implemented in the (Microsoft Active Directory)
`Kerberos` protocol:
  - `unconstrained delegation`,
  - `constrained delegation`,
  - `resource-based constrained delegation (RBCD)`.

Service accounts that are trusted for `unconstrained delegation`, i.e service
accounts with the `ADS_UF_TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION` flag being
positioned in their `User-Account-Control` attribute, can fully act on behalf
of other domain users. `Service tickets` received by such services will contain
a copy of the `TGT` of the user accessing the service. The received `TGTs` can
be extracted from the `LSASS` process of the machine running the service /
receiving the authentication, and further used to authenticate to any domain
resources.

Service accounts that are trusted for `constrained delegation`, i.e service
accounts with a non-empty `msDS-AllowedToDelegateTo` attribute, can impersonate
other domain users to configured services (in the service account 's
`msDS-AllowedToDelegateTo` attribute). `Constrained delegations` are
implemented into the `Kerberos` protocol by Microsoft through the
`Service-for-User-to-Proxy (S4U2proxy)` extension. `S4U2proxy` allows service
accounts to request `service tickets` to the `KDC` (`TGS-REQ`) on behalf of
other users by arbitrarily specifying the name of the user the `service ticket`
should be emitted to. In order to do so, the service account must join, in the
`req-body.additional-tickets` field of the `TGS-REQ` request, a
`service ticket` marked as `forwardable` from the specified user.

The `resource-based constrained delegation`, introduced in Windows
Server 2012, deports the trust to the final resources. Instead of trusting a
service account to impersonate other users to destination services, service
accounts can specifically authorize other services to authenticate using
delegated `service tickets`. The authorized services are identified, by their
`SPN`, in the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute of the
final services. Similarly to `constrained delegation`, the service accessing
the final service will request a `service ticket` to the `KDC` on behalf of a
domain user through a `S4U2proxy` request. Except that in a `resource-based
constrained delegation` scenario, the "proxifying" service can provide a
standard `service ticket` to the `KDC` and thus does not have to be in
possession of a `service ticket` marked as `forwardable` from the specified
user.   

The services a service account can request `S4U2proxy` `service tickets` for
are restricted by the `KDC` to the ones either:
  - *`[constrained delegation]`* configured, using their `SPNs`, in the
  requesting service account's `msDS-AllowedToDelegateTo` attribute.
  - *`[resource-based constrained delegation]`* having in their
  `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute the `SPN` of the
  requesting service.

###### Service-for-User-to-Self (S4U2self)

In order to provide protocol transition, Microsoft implemented the `S4U2self`
extension into the `Kerberos` protocol. This extension makes `Kerberos`
delegation possible for domain users accessing a service through other Windows
authentication protocols, such as the `NT Lan Manager (NTLM)` protocol. As a
`service ticket` is required for `Kerbeors` `constrained` and `resource-based
constrained delegation` (both leveraging the `Kerberos` `S4U2proxy` extension),
the `S4U2self` allows a service account to obtain a `service ticket` for itself
of an arbitrarily specified user. The user is specified in the of the
`PA-FOR-USER` field in the `preauthentication data` of the `KRB_TGS_REQ`
request to the `KDC`.

Any service account can request `service tickets` for itself through the
`S4U2self` extension. However, only service accounts configured as being able
to `"use any authentication protocol"`, which correspond to the
`ADS_UF_TRUSTED_TO_AUTHENTICATE_FOR_DELEGATION` flag being positioned in the
service accounts' `User-Account-Control` attribute, will receive `service
tickets` marked as `forwardable`.

The `S4U2self` `service tickets` contain, in its `Privilege Attribute
Certificate (PAC)`, the `authorization data` of the requested user and can be
used:

  - to impersonate the user locally on the system executing the service if the
  service account has the `SeTcbPrivilege` privilege on the local system.

  - through a `constrained delegation` to impersonate the user on remote
  services, using subsequent `S4U2proxy` requests, if the `S4U2self`
  `service ticket` is marked as `forwardable`. The `S4U2self` `service ticket`
  can only be used to make `S4U2proxy` requests for the services defined in
  the receiving service account's `msDS-AllowedToDelegateTo` attribute.

  - through a `resource-based constrained delegation` to impersonate the user
  on remote services, using subsequent `S4U2proxy` requests, even if the
  `S4U2self` `service ticket` is **not** marked as `forwardable`. Indeed,
  in a `resource-based constrained delegation` scenario, `S4U2Proxy` requests
  will grant `service tickets` for services even if the `service ticket`
  provided to the `KDC` is non-`forwardable`. The `S4U2self` `service ticket`
  can only be used to make `S4U2proxy` requests for the services that define in
  their `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute the service
  emitting the `S4U2self` `service ticket`.

###### Accounts that cannot be delegated

Domain users can be protected from `Kerberos` delegation by either being:
  - configured as non-delegable (`"Account is sensitive and cannot be
    delegated"`), which correspond to the `ADS_UF_NOT_DELEGATED` flag being
    positioned in a user' `User-Account-Control` attribute.
  - members of the `Protected Users` domain group.

### Identification of domain accounts that can be delegated

The PowerShell cmdlets below list all domain accounts that are not tagged as
non-delegable nor are direct member of the `Protected Users` domain group.

```
Get-ADUser -Filter * -Properties AccountNotDelegated,MemberOf | Where-Object {($_.AccountNotDelegated -eq $False) -and -not ($_.Memberof -match "Protected Users")}
Get-DomainUser -Properties * | Where-Object {-not ($_.useraccountcontrol -match "NOT_DELEGATED") -and -not ($_.memberof -match "Protected Users")} | F
```

The PowerShell script below can be used to list the members of the privileged
domain groups that are delegable (with out the `ADS_UF_NOT_DELEGATED` flag
being set in their `User-Account-Control` attribute nor are direct or indirect
member of the `Protected Users` domain group).

```
# Targeted privileged groups: "Domain Admins" (-512), "Enterprise Admins" (-519), "Administrators" (-544), "Backup Operators" (-551), "DNS Admins" (> 1000), "Print Operators" (-550), "Server Operators" (-549), "Account Operators" (-548), "Schema Admins" (-518)

$Users = Get-ADUser -Filter {AccountNotDelegated -eq $False}
$ProtectedUsers = Get-ADGroupMember -Identity "Protected Users" -Recursive

$DelegableUsers = Compare-Object $Users $ProtectedUsers | Select-Object -Expand InputObject | Sort-Object | Get-Unique

$DomainSID = (Get-ADDomain).DomainSID
$DomainAdminsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::AccountDomainAdminsSid, $DomainSID)
$EnterpriseAdminsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::AccountEnterpriseAdminsSid, $DomainSID)
$AdministratorsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::BuiltinAdministratorsSid, $DomainSID)
$BackupOperatorsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::BuiltinBackupOperatorsSid,$DomainSID)
$DnsAdminsSID = (Get-ADGroup -Identity "DnsAdmins").SID
$PrintOperatorsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::BuiltinPrintOperatorsSid,$DomainSID)
$ServerOperatorsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::BuiltinSystemOperatorsSid,$DomainSID)
$AccountOperatorsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::BuiltinAccountOperatorsSid,$DomainSID)
$SchemaAdminsSID = New-Object System.Security.Principal.SecurityIdentifier ([System.Security.Principal.WellKnownSidType]::AccountSchemaAdminsSid,$DomainSID)

$PriviligedUsers = Get-ADGroup -Filter {(SID -eq $DomainAdminsSid) -or (SID -eq $EnterpriseAdminsSID) -or (SID -eq $AdministratorsSID) -or (SID -eq $BackupOperatorsSID) -or (SID -eq $DnsAdminsSID) -or (SID -eq $PrintOperatorsSID) -or (SID -eq $ServerOperatorsSID) -or (SID -eq $AccountOperatorsSID) -or (SID -eq $SchemaAdminsSID)} | Get-ADGroupMember -Recursive | Sort-Object | Get-Unique

$DelegablePriviligedUsers = @()
foreach ($DelegableUser in $DelegableUsers){
  foreach ($PriviligedUser in $PriviligedUsers){
   If ($DelegableUser.SamAccountName -eq $PriviligedUser.SamAccountName) {
      $DelegablePriviligedUsers += $DelegableUser
	}
  }
}

$DelegablePriviligedUsers
```

### Unconstrained delegation exploit

###### Unconstrained delegation accounts identification

The `ADS_UF_TRUSTED_FOR_DELEGATION` flag configured in its
`User-Account-Control` attribute.

```
# Computer accounts
Get-DomainComputer -Unconstrained
Get-ADComputer -Filter {TrustedForDelegation -eq $True}
Get-ADComputer -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"

# User accounts
Get-DomainUser -ldapfilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"
Get-ADUser -Filter {TrustedForDelegation -eq $True}
Get-ADUser -LDAPFilter "(userAccountControl:1.2.840.113556.1.4.803:=524288)"
```

###### TGT monitoring

```
Rubeus monitor
```

### Resource-based constrained delegation exploit
