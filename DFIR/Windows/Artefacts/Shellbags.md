# DFIR - Windows - Shellbags

### Overview

Location (starting from `Windows 7`):

  - Files:  
    `%SystemDrive%:\Users\<USERNAME>\NTUSER.dat`  
    `%SystemDrive%:\Users\<USERNAME>\AppData\Local\Microsoft\Windows\UsrClass.dat`

  - Registry keys:  
    - `NTUSER.DAT\Software\Microsoft\Windows\Shell\BagMRU`  
      `NTUSER.DAT\Software\Microsoft\Windows\Shell\Bags`  
      => Information related to Desktop activity.

    - `UsrClass.dat\Local Settings\Software\Microsoft\Windows\Shell\BagMRU`  
      `UsrClass.dat\Local Settings\Software\Microsoft\Windows\Shell\Bags`  
      => Information related to `Windows Explorer` activity.

    -  `NTUSER.DAT\Software\Microsoft\Windows\ShellNoRoam\Bag`  
       `NTUSER.DAT\Software\Microsoft\Windows\ShellNoRoam\BagMRU`  
       => Unclear usage and limited forensic research.  

Yield information related to **files and folders access**.

The `Shellbags` are `Windows Registry keys` designed as an user experience
enhancing feature to keep track of Windows explorer graphical display settings
on a folder-by-folder basis. For instance, a `Shellbag` entry is used to store
the `View` mode of a folder (details, list, small / medium / large icons) as
well as the column displayed (entry names, dates, sizes, etc.) and their order.

`Shellbags` entries are also generated by access to the `Control Panel`
settings, on an interface-by-interface basis. The `Shellbags` entries related
to the `Control Panel` can notably be useful to detect possible `Windows
Firewall` (`Control Panel\All Control Panel Items\Windows Defender
Firewall\Customize Settings`) or `Credential Manager` (`Control Panel\User
Accounts\Credential Manager`) operations.

Various kinds of user activity may generate or update `Shellbag` entries (with
different level of data depending on the activity):
  - **first access** or renaming of folders, removable devices, or network
    shares through the `Windows Explorer` **systematically generate a
    `Shellbag` entry**
  - graphical opening of compressed archives or `ISOs`
  - access to the `Control Panel` interface
  - modification of the folder view preferences
  - etc.

`Shellbag` entries are stored in registry as a tree-like data structure, with
the root target having the topmost `BagMRU` key. Each node subkeys then
represent the child-bags / sub-targets (subdirectories for example) of the
parent target. For example, on a default Windows installation (in English),
`My Computer` will be associated with the topmost `BagMRU` key, `C:` to
`BagMRU\1`, and `C:\Users` to ` BagMRU\1\3`. A hierarchical view of the
`Shellbag` entries can thus be established.

### Information of interest

As the `Shellbags` entries are stored in user's specific registry hives,
**targets** (folders, `Control Panel` interfaces, etc.) **access can be tied
to a given user** through its `Shellbags`. `Shellbags` entries are populated
only upon interaction (i.e are not prepopulated), the mere presence of a
`Shellbag` entry for a target is thus evidence that the user interacted with
the given target. `Shellbags` entries are not automatically deleted upon
deletion of the related folders and can thus be a **source of historical
information**.

The `Shellbags` entry for a given target yield the following information of
forensic interest:
  - the **target name and absolute path**.

  - the **target `Modified, Access, and Created (MAC)` timestamps** (`UTC`),
    retrieved from the `$MFT` at the `Shellbag` entry creation (and not further
    updated).

  - each entry in `ShellBags` `BagMRU` maintain a `MRUListEx` list, which
    records **the order in which the sub targets of a target were accessed**
    (the last sub target accessed having a `MRU position` of 0).


The **first and last interacted timestamps** can be **indirectly deducted
for some targets**:
  - The `First Interacted` timestamp can be inferred for some targets thanks to
    the tree like data structure of `ShellBags` entry.

  - The `Last Interacted` timestamp can be deducted for **the sub target that
    was last interacted with**. Indeed, as each `Shellbag` entry corresponds to
    a registry key, the key's `LastWriteTime` timestamp indicates when the
    `Shellbag` entry was last updated. The child-bag / sub-target that was last
    interacted with being known (`MRU position` of 0), this timestamp
    correspond to the last interaction timestamp for the sub target that was
    last interacted with.

### Parsing

Eric Zimmerman's `ShellBagsExplorer.exe` and `SBECmd.exe` tools (`KAPE`'s
`SBECmd` module) can be used to parse `ShellBags` entries.

`ShellBagsExplorer.exe` displays the `ShellBags` entries in a graphical user
interface that allow browsing of the referenced targets, in a similar manner to
`Windows Explorer`.

```
# Recursively enumerates the users' registry hives in the specified directory and parses their ShellBags entries.
SBECmd.exe --csv <CSV_DIRECTORY_OUTPUT> -d <C:\Users\<USERNAME> | C:\Users\ | DIRECTORY>

# Parses the ShellBags entries in the live registry.
SBECmd.exe --csv <CSV_DIRECTORY_OUTPUT> -l
```
