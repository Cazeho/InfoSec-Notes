# WebApps - File upload

A file upload functionality exposes a web application to new types of
vulnerabilities if the functionality is not correctly restricted.

Indeed, a file upload functionality could be exploited to overload the file
system or databases, target the web application users or take over the web
server.

Note that every check (file type and size, number of files uploaded by the
current user, etc.) should be implemented server-side as client-side checks are
always circumventable.

### Denial of service

A file upload functionality could be leveraged to realize a denial of service
of the web application or server by:

  - overwriting specific web application (`.htaccess`, `web.config`, etc.) or
    operating system (`/etc/passwd`, `C:\Windows\System32\drivers\pci.sys`,
    etc.) files ;
  - exhausting the server disk storage capacity through the upload of many
    large files. A restriction should be implemented on the file size and
    number of files each users can upload.

### Users' Workstations takeover

The users or administrators of the web application can be targeted trough the
upload of malicious files.

The following malicious files could be used to execute code on the users
workstation:

  - Malicious binaries (`.exe`, etc.) or scripts (`sh`, `.dat`, etc.) that must
    be executed by the users
  - Office documents containing malicious macro (`.docm`, `.pptm`, `.xlsm`,
    etc.) that could be executed when opened
  - `PDF` files containing payloads exploiting vulnerabilities in one or
    multiples `PDF` readers such as `Adobe Acrobat Reader`
  - `CSV` files containing `CSV` injections, triggered when opening the files
    with a `CSV` reader such as `Excel`, etc.
  - Files triggering vulnerabilities in real-time monitoring tools such as
    anti-virus solutions      

### Remote Code Execution

An unrestricted or poorly hardened file upload functionality could be exploited,
in combination with a Local File Inclusion vulnerability to remotely execute
code on the web server.

The exploitation process is as follow:
  - upload of a file containing code in a language supported by the web
    application
  - retrieval of the file path on the server file system through an information
    disclosure vulnerability
  - Access and execution of the file by the web application using the local
    file inclusion vulnerability        

##### Upload file path

Knowledge of the uploaded files path could be needed in order to include the
files through a local file inclusion vulnerability if the upload directory is
different from the file inclusion vulnerability base directory.

The upload directory path may be leaked by the web application, usually in
error messages or in settings / configuration web pages.

To following techniques may be used to trigger an error trough the file upload
functionality by uploading files with:

  - an already existing file or folder name
  - a overly long name
  - a name containing invalid characters such as:
    ```
     .|<>*?"'`
    ```
  - a name reserved or forbidden such as:
    ```
    # Windows
    CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, and LPT9
    ```

##### Upload filters bypass

Nowadays web applications usually implement a filter mechanism to limit the
file types that can be uploaded on the web server. The filter is generally
designed to protect the web application against the upload of executable files.

Multiple filter mechanisms can be used to restrict the files accepted by the web
application:   
  - client-side restrictions
  - HTTP `Content-Type` verification
  - file type detection   
  - file extensions black or white listing

Of the above mechanisms, only the white listing of authorized file extensions
should be considered secure.

*Client-side restrictions*

Client-side restrictions, usually implemented using `JavaScript`, can be
constantly bypassed.

If the deactivation of `JavaScript` makes the web application unfunctional or
does not suffice to bypass the filter, the HTTP request should be tampered
using a proxy.

*Content-Type verification*

A verification on the MIME type specified in the `Content-Type` parameter of
the HTTP upload POST request may be implemented. For example, a verification
can be made to ensure that the MIME type correspond to an image on a image
upload functionality.   

Such mechanism can be bypassed by tampering the `Content-Type` value, for
example to `image/jpeg`, `image/png` or `image/gif`.

*file extension black listing*

A black listing

*file extension white listing*

Double extensions
