# Android - Static Analysis

### APK disassembling

Apktool can be used to disassemble and decode resources including
AndroidManifest.xml, resources.arsc, classes.dex, etc.  
The tool can also be used to rebuild the decoded resources back to a binary
APK/JAR after modifications.
```
# Disassemble
apktool d <App.apk>

# Rebuild
apktool b <Apk_folder/>
```

### Automated static analysis

###### Mobile Security Framework (MobSF)

Automated mobile application pen-testing framework capable of performing static
(and dynamic) analysis.  
Performs a review of the AndroidManifest.xml file, print the certifcat used to
sign the APK, decompile the dex files and look for specific keywords, etc.  
More information : https://github.com/MobSF/Mobile-Security-Framework-MobSF
```
# Start MobSF
python manage.py runserver

# Then go to http://127.0.0.1:8000 and upload the APK.
```

###### Quick Android Review Kit (QARK)

In addition to conducting similar testing as MobSF, QARK undertakes a deeper
code review and allows for the creation of an APK to exploit client-side
misconfigurations and vulnerabilities.
More information : https://github.com/linkedin/qark
```
python qarkMain.py  
```

### Certificate analysis

For a detailed explanation on the usefulness and importance of the certificate
used to sign the APK refer to 1.2-Overview_Application_Stack#Certificate.

The certificate, to be found in the META-INF folder, can be displayed using
openssl:
```
openssl pkcs7 -inform DER -in CERT.RSA -noout -print_certs -text
```
The tool jarsigner can be used to verify the signatures and integrity of the
APK files:
```
jarsigner -verify -certs -verbose <App.apk>
```

Check that the application is not signed with a debug certificate, insecure by
design, and that the signature algorithm used is crytographically robust.  

If the application does not need to be compatible with older Android devices
using Android < 4.3, the sha256WithRSAEncryption signature algorithm, with a
minimum RSA key size of 2048, is recommended. If the application needs to be
retrocompatible, the cryptographic hash function SHA1 can be used instead of
SHA256 (sha1WithRSAEncryption).  


### AndroidManifest.xml analysis

###### Manual extract

While it is recommended to use Apktool to fully extract and decode the APK,
the following tools may be used to convert the AndroidManifest.xml file into a
human readable text file :
```
# Complete extract of the manifest
java -jar AXMLPrinter2.jar <AndroidManifest.xml> > AndroidManifest_readable.xml

# Permissions and activities extract
aapt dump badging <App.apk>  
```

###### Permissions

Review that the permissions granted to the application are in accordance with
the application usage.  
Note that the *android.permission.INTERNET* should NOT be considered dangerous
(as incorrectly stated by MobSF).  

The following permissions are considered sensitive by the Android development
team :

|Sensible permissions |
|---|
| READ_CALENDAR | WRITE_CALENDAR | CAMERA | READ_CONTACTS |
| WRITE_CONTACTS | GET_ACCOUNTS | ACCESS_FINE_LOCATION | ACCESS_COARSE_LOCATION |
| RECORD_AUDIO | READ_PHONE_STATE | READ_PHONE_NUMBERS | CALL_PHONE |
| ANSWER_PHONE_CALLS | READ_CALL_LOG | WRITE_CALL_LOG | ADD_VOICEMAIL |
| USE_SIP | PROCESS_OUTGOING_CALLS | BODY_SENSORS | SEND_SMS |
| RECEIVE_SMS | READ_SMS | RECEIVE_WAP_PUSH | RECEIVE_MMS |
| READ_EXTERNAL_STORAGE | WRITE_EXTERNAL_STORAGE |

While most of the permissions names are self explanatory, more information can
be found on the Android website :
https://developer.android.com/guide/topics/permissions/overview

###### Activities

The application activities can be exported with the **android:exported**
attribute set to true. By default activities are not exported
(*android:exported="false"*).    
Exported activities can be launched by others applications present on the
endpoint.   
If an intent filter is specified, the activity is automatically exported and the
activity available to launch through the intent filter conditions.  
If the attribute is set with no intent filter specified, the activity can be
launched by others applications through its full name.  
Exported activities functionalities should be reviewed and potential use cases
analyzed.

###### Debug mode

The **android:debuggable** attribute, set in the *<application\>* element of the
AndroidManifest, determines whether or not the application can be debugged.  
By default this attribute is disabled, i.e., set to false.  
An application should never be released with this attribute set to true as it
enables users to gain access to details of the app that should be kept secure.
For example, ...

###### Backup mode

###### Broadcast, services, etc.

###  Code review


###### Manual extract

The JAVA sources files of the APK can be retrieved using MobSF, QARK or the
following method:
```
d2j-dex2jar.sh -f -o <App_jar.jar> <App.apk>

# Open the jar file with JD-Gui and File > Save All Sources
```

###### Sensible plain-text information

Search for sensible plain-text variables using the following keywords:
```
grep -ri 'user' <Apk_folder>
grep -ri 'pass' <Apk_folder>
grep -ri 'key' <Apk_folder>
grep -ri 'api' <Apk_folder>
```
